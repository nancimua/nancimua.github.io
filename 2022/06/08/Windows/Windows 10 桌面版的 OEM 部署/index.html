<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>Windows 10 桌面版的 OEM 部署 | 南辞的家</title>

  <link rel="icon" type="image/png" href="https://picx.zhimg.com/80/v2-c7fcadd83875ab40da79d66fce108981_1440w.png">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" rel="stylesheet">
  
  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script defer src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    
    
    <!-- 依赖于jquery和vue -->
    
        <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    

    
        <script src="https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.min.js"></script>
    

    <!-- import link -->
    
        
            
        
            
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 6.3.0"></head>

  
  <!-- 预加载动画 -->
  <!-- 页面预加载动画 -->

  
    <div class="preloader_2" id="loader">
  <div class="loader"></div>
</div>

  
<script>
  var endLoading = function () {
    document.body.style.overflow = 'auto';
    document.getElementById('loader').classList.add("loading");
  }
  window.addEventListener('DOMContentLoaded',endLoading);
</script>

  <body>
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (src) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://unpkg.com/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header  " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="https://picx.zhimg.com/80/v2-d6a5f19dc2318873e2286b086a97ded0_1440w.png" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-d6a5f19dc2318873e2286b086a97ded0_1440w.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
      <h3 class="drawer-box-head_title">南辞的家</h3>
      <h5 class="drawer-box-head_desc">欢迎来到南辞的小天地，这里有生活的点滴、技术的探索和对世界的思考。</h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/categories" class="drawer-menu-item-link">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/aboutme" class="drawer-menu-item-link">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/friends" class="drawer-menu-item-link">
                  
                    <i class="fas fa-users" aria-hidden="true"></i>
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/689915465" class="drawer-menu-item-link">
                  
                    <i class="fa-brands fa-bilibili" aria-hidden="true"></i>
                  
                  <span class="name">哔哩哔哩</span>
                </a>
              
            </li>
          
        
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="https://picx.zhimg.com/80/v2-d6a5f19dc2318873e2286b086a97ded0_1440w.png" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-d6a5f19dc2318873e2286b086a97ded0_1440w.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
        </div>
      
      <a href="/" class="logo">南辞的家</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="首页">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="归档">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="标签">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/categories" class="menu-item-link" title="分类">
                  
                    <i class="fas fa-bookmark" aria-hidden="true"></i>
                  
                  <span class="name">分类</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/aboutme" class="menu-item-link" title="关于">
                  
                    <i class="fas fa-user" aria-hidden="true"></i>
                  
                  <span class="name">关于</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/friends" class="menu-item-link" title="友情链接">
                  
                    <i class="fas fa-users" aria-hidden="true"></i>
                  
                  <span class="name">友情链接</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/689915465" class="menu-item-link" title="哔哩哔哩">
                  
                    <i class="fa-brands fa-bilibili" aria-hidden="true"></i>
                  
                  <span class="name">哔哩哔哩</span>
                </a>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">本地搜索</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="请输入关键字"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
  
    <div id="he-plugin-simple"></div>
    <script>
      WIDGET = {
        CONFIG: {
          "modules": "012",
          "background": 5,
          "tmpColor": "4A4A4A",
          "tmpSize": 16,
          "cityColor": "4A4A4A",
          "citySize": 16,
          "aqiSize": 16,
          "weatherIconSize": 24,
          "alertIconSize": 18,
          "padding": "10px 10px 10px 10px",
          "shadow": "1",
          "language": "auto",
          "borderRadius": 5,
          "fixed": "false",
          "vertical": "middle",
          "horizontal": "center",
          "key": "2784dd3fcb1e4f0f9a9b579bf69641f2"
        }
      }
    </script>
    <script defer src="https://widget.qweather.net/simple/static/js/he-simple-common.js?v=2.0"></script> 
    
</header>
        <!-- 内容区域 -->
        
 <!-- prismjs 代码高亮 -->
 


<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('https://picx.zhimg.com/80/v2-5c953f1cfbabe6b9dd204712e7e63461_1440w.jpeg')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        Windows 10 桌面版的 OEM 部署
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> 发表于：2022-06-08 |
        </span>
      

      
        <span class="post-detail-header_categories">
          <i class="iconfont iconbookmark1"></i> 分类：
          
            <a href="/categories/Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-detail-header_category">
              Windows操作系统
            </a>
          
        </span>
      

      
    
  </div>
  
  
</div>





<div class="post-detail-content post-row" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <p>已准备好构建并测试 Windows 10 台式电脑？ 本实验演示制作和部署 Windows 映像的步骤。 我们将演示如何使用工具和命令设置端到端部署。 可以编写针对这些命令的脚本，帮助你针对特定市场快速自定义新映像以便满足客户需求。</p>
<p>我们将引导你完成生成自定义 Windows 部署的过程。 下面是要介绍的内容：</p>
<p><img src="https://pic1.zhimg.com/80/v2-a8194f8f40a708abfb299b7b81321661_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pic1.zhimg.com/80/v2-a8194f8f40a708abfb299b7b81321661_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>
<p>我们从准备环境开始，然后介绍以下步骤：</p>
<ul>
<li>准备和装载 WinPE 映像</li>
<li>添加包</li>
<li>添加驱动程序</li>
<li>创建 WinPE 媒体</li>
</ul>
<p>接下来，继续自定义 Windows 映像。 我们首先对装载的 Windows 映像进行<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#customize-your-windows-image">脱机自定义</a>，在此过程中我们将介绍：</p>
<ul>
<li>添加驱动程序</li>
<li>添加语言</li>
<li>添加更新</li>
<li>重新安装内置应用</li>
<li>预安装 Microsoft Office</li>
<li>将磁贴添加到“开始”菜单布局</li>
<li>设置 OOBE 以显示自定义 EULA</li>
<li>配置并使用应答文件来自定义 Windows 安装程序</li>
</ul>
<p>我们通过<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#use-a-deployment-script-to-apply-your-image">将映像部署到电脑，并启动进入审核模式</a>来完成 Windows 映像的自定义，然后完成更改，这包括：</p>
<ul>
<li>在审核模式下进行更改</li>
<li>准备一键重置</li>
</ul>
<p>最后，我们将<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#finalize-and-capture-your-image">最终确认并捕获映像，验证是否一切正常，并准备映像以进行部署</a>。</p>
<ul>
<li>确定映像</li>
</ul>
<p>让我们开始吧！</p>
<h2 id="准备实验室环境"><a href="#准备实验室环境" class="headerlink" title="准备实验室环境"></a>准备实验室环境</h2><p> 备注</p>
<p>如果你尚未收集完成本实验所需的文件，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions-get-tools?view=windows-10">获取 Windows 10 桌面版的 OEM 部署所需的工具</a>。</p>
<p>此时，应已准备好所需的工具。 现在应已获得：</p>
<p>一个 USB 驱动器，已格式化为两个分区，其 NTFS 分区 (O:) 包含以下内容：</p>
<ul>
<li>从 USB-B 中提取的文件夹结构和文件</li>
</ul>
<p>一台技术人员电脑，其中包含：</p>
<ul>
<li>名为<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\temp\lab</span><br></pre></td></tr></table></figure>
的文件夹，以下媒体已下载到其中：<ul>
<li>Windows 安装媒体</li>
<li>最新版本的 Microsoft Office OPK</li>
<li>Windows 按需功能 ISO</li>
<li>Windows 语言包 ISO</li>
<li>OPK 应用更新或内置应用 ISO</li>
<li>Windows ADK 安装程序</li>
<li>WinPE ADK 加载项（如果使用适用于 Windows 10 版本 1809 或更高版本的 ADK）</li>
<li>映像的驱动程序（如果需要）</li>
</ul>
</li>
</ul>
<p>让我们设置实验。</p>
<h3 id="安装适用于-Windodws-10-的-Windows-ADK"><a href="#安装适用于-Windodws-10-的-Windows-ADK" class="headerlink" title="安装适用于 Windodws 10 的 Windows ADK"></a>安装适用于 Windodws 10 的 Windows ADK</h3><p>Windows ADK 是可用于管理自定义 Windows 安装并将其部署到新计算机中的一系列工具。</p>
<p> 重要</p>
<p>请对所要自定义的映像使用匹配的 ADK 版本。 例如，如果使用的是 Windows 10 版本 1809，请使用适用于 Windows 10 版本 1809 的 ADK。</p>
<p>在技术人员电脑上：</p>
<ol>
<li>如果你有以前版本的 Windows 评估和部署工具包 (ADK)，请将其卸载。</li>
<li>下载与你要安装的 Windows 版本匹配的 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/get-started/adk-install">Windows ADK</a> 版本。</li>
<li>结合以下选项运行 ADK 安装程序以安装 ADK。 如果使用的是适用于 Windows 10 版本 1809 的 ADK，WinPE 不会随附在 ADK 安装程序中，而是一个独立的加载项包，在安装 ADK 后必须安装该包：</li>
</ol>
<ul>
<li>部署工具</li>
<li><strong>用户状态迁移工具 (USMT)</strong></li>
<li><strong>Windows 预安装环境 (Windows PE)</strong></li>
</ul>
<ol>
<li>安装完成后，关闭安装程序窗口。</li>
</ol>
<h2 id="创建可启动的-Windows-PE-WinPE-分区"><a href="#创建可启动的-Windows-PE-WinPE-分区" class="headerlink" title="创建可启动的 Windows PE (WinPE) 分区"></a>创建可启动的 Windows PE (WinPE) 分区</h2><p>WinPE 是基于命令行的小型操作系统，可用于捕获、更新和优化 Windows 映像。 本部分介绍如何在可启动 USB 闪存驱动器上准备基础 WinPE 映像并试用。</p>
<h3 id="准备-WinPE-文件"><a href="#准备-WinPE-文件" class="headerlink" title="准备 WinPE 文件"></a>准备 WinPE 文件</h3><ol>
<li><p>在技术人员电脑上，以管理员身份启动部署和映像工具环境：</p>
<ul>
<li>单击<strong>开始</strong>，键入<strong>部署和映像工具环境</strong>。 右键单击<strong>部署和映像工具环境</strong>，然后选择<strong>以管理员身份运行</strong>。</li>
</ul>
</li>
<li><p>使用 <code>copype</code> 创建一个包含基础 WinPE 文件的工作目录：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copype amd64 C:\winpe_amd64</span><br></pre></td></tr></table></figure>
<p> 提示</p>
<p>如果这不起作用，请确保你处于部署和映像工具环境中，而不是在标准命令提示符下。</p>
</li>
</ol>
<h3 id="自定义-WinPE"><a href="#自定义-WinPE" class="headerlink" title="自定义 WinPE"></a>自定义 WinPE</h3><p>可以通过将文件和组件添加到装载的 WinPE 映像，以多种方式自定义 WinPE 映像 (boot.wim)。</p>
<p>下面是有关如何修改 WinPE 映像的一些示例：</p>
<ul>
<li>添加可选组件。 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/winpe-add-packages--optional-components-reference?view=windows-10">WINPE 可选组件</a> 在 ADK 中提供。 可将这些包添加到 WinPE 映像，以向 WinPE 添加功能。</li>
<li>添加显卡驱动程序或网络驱动程序。 （WinPE 包括通用视频和网络驱动程序，但在一些情况下，需要附加驱动程序来显示屏幕或连接到网络。） 要了解详细信息，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/add-and-remove-drivers-to-an-offline-windows-image?view=windows-10">WinPE：添加驱动程序</a>。</li>
<li><strong>将电源方案设置为高性能</strong>。 加快部署。 请注意，我们的示例部署脚本已自动设置此方案。 请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/winpe-mount-and-customize?view=windows-10#set-the-power-scheme-to-high-performance">WinPE：装载和自定义：高性能</a>。</li>
<li><strong>优化 WinPE</strong>：建议用于具有有限内存和存储的设备（例如，1GB RAM&#x2F;16GB 存储）。 在你向 Windows PE 添加驱动程序或其他自定义项后，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/compact-os?view=windows-10#image-optimization">WinPE：优化和缩小映像</a>以帮助缩短启动时间。</li>
</ul>
<p>将包添加到 WinPE 时，性能将会下降，启动时间将会延长。 请仅添加成功完成部署所需的包。</p>
<h4 id="装载-WinPE-映像"><a href="#装载-WinPE-映像" class="headerlink" title="装载 WinPE 映像"></a>装载 WinPE 映像</h4><p>若要自定义某个 Windows 映像，必须先装载该映像，然后才能使用它。 对 WinPE 映像也是如此。 装载映像会将映像文件的内容提取到某个位置，可在该位置查看和修改此文件。 在整个实验中，我们将使用 DISM 来装载和修改映像。 DISM 已随附在 Windows 中，但我们将使用 ADK 安装的版本。我们将通过部署和映像工具环境访问该版本。</p>
<p>Boot.wim 是 WinPE 映像文件。 可以在使用 copype.cmd 复制的文件中找到它。</p>
<p>装载映像：</p>
<ul>
<li>在“部署和映像工具环境”中装载映像：</li>
</ul>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /mount-image /imagefile:c:\WinPE_amd64\media\sources\boot.wim /index:1 /mountdir:c:\winpe_amd64\mount</span><br></pre></td></tr></table></figure>

<h4 id="将包、可选组件、依赖项和语言包添加到-WinPE（可选）"><a href="#将包、可选组件、依赖项和语言包添加到-WinPE（可选）" class="headerlink" title="将包、可选组件、依赖项和语言包添加到 WinPE（可选）"></a>将包、可选组件、依赖项和语言包添加到 WinPE（可选）</h4><p>使用 <code>Dism /Add-Package</code> 将包添加到装载的 WinPE 映像。 ADK 包含 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/winpe-add-packages--optional-components-reference?view=windows-10">WinPE 可选组件</a>，可以添加这些组件以获得更多的 WinPE 功能。 某些包具有依赖项，要求安装其他包。 对于这些包，必须在添加包之前安装依赖项。 例如，如果要在 WinPE 中使用 Powershell，则必须安装 NetFx 以及特定于语言的 OC。 可以在 <code>C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\&lt;arch&gt;\WinPE_OCs\</code> 中找到 OC CAB。 下面演示了如何添加适用于美国英语 (en-us) 的 Powershell 支持：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:&quot;C:\WinPE_amd64\mount&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-WMI.cab&quot;  /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-WMI_en-us.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-NetFX.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-NetFX_en-us.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-Scripting.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-Scripting_en-us.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-PowerShell.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-PowerShell_en-us.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-StorageWMI.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-StorageWMI_en-us.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\WinPE-DismCmdlets.cab&quot; /PackagePath:&quot;C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\en-us\WinPE-DismCmdlets_en-us.cab&quot;</span><br></pre></td></tr></table></figure>

<p> 备注</p>
<p>仅在需要时添加附加包。 添加的包越多，对启动时间和性能的影响就越大。</p>
<h4 id="将驱动程序添加到-WinPE（如果需要）"><a href="#将驱动程序添加到-WinPE（如果需要）" class="headerlink" title="将驱动程序添加到 WinPE（如果需要）"></a>将驱动程序添加到 WinPE（如果需要）</h4><p>如果需要将驱动程序添加到 WinPE，请使用 <code>Dism /Add-Driver</code>。 仅当 WinPE 尚不包含硬件的驱动程序时，才需要执行此操作。</p>
<p>下面演示了如何将驱动程序添加到 WinPE：</p>
<p> 备注</p>
<p>此方法需要基于 .inf 的驱动程序。 从硬件供应商处获取基于 .inf 的驱动程序。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:C:\winpe_amd64\mount /Add-Driver /driver:&quot;C:\Out-of-Box Drivers\mydriver.inf&quot;</span><br></pre></td></tr></table></figure>

<p>其中 <code>C:\Out-of-Box Drivers\mydriver.inf</code> 是要添加的驱动程序的路径。</p>
<p>若要安装文件夹及其所有子文件夹中的所有驱动程序，请使用 &#x2F;recurse 选项。 例如：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:C:\Winpe_amd64\mount /Add-Driver /Driver:c:\drivers /recurse</span><br></pre></td></tr></table></figure>

<p>其中 <code>C:\drivers</code> 是要添加的驱动程序文件夹。</p>
<h3 id="将电源方案设置为高性能"><a href="#将电源方案设置为高性能" class="headerlink" title="将电源方案设置为高性能"></a>将电源方案设置为高性能</h3><p>将 WinPE 设置为使用高性能模式可以加快部署速度。 示例脚本在运行时会将 WinPE 设置为高性能模式，但如果你想要确保 WinPE 始终以高性能模式运行，可以<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/wpeinit-and-startnetcmd-using-winpe-startup-scripts?view=windows-10">修改 WinPE 映像中的 <code>startnet.cmd</code></a>。</p>
<ol>
<li><p>使用记事本打开 C:\Winpe_amd64\mount\windows\system32\startnet.cmd</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notepad C:\Winpe_amd64\mount\windows\system32\startnet.cmd</span><br></pre></td></tr></table></figure>
</li>
<li><p>将以下行添加到 startnet.cmd：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c</span><br></pre></td></tr></table></figure>
</li>
<li><p>保存文件并关闭记事本。</p>
</li>
</ol>
<h3 id="清理-WinPE-映像"><a href="#清理-WinPE-映像" class="headerlink" title="清理 WinPE 映像"></a>清理 WinPE 映像</h3><p>运行 <code>dism /cleanup-image</code> 以减少 WinPE 的磁盘和内存占用量，并提高与各种设备的兼容性：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /image:c:\winpe_amd64\mount /Cleanup-image /StartComponentCleanup</span><br></pre></td></tr></table></figure>

<p>有关更多详细信息，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/compact-os?view=windows-10#image-optimization">WinPE：优化和缩小映像</a>。</p>
<h3 id="提交更改并卸载映像"><a href="#提交更改并卸载映像" class="headerlink" title="提交更改并卸载映像"></a>提交更改并卸载映像</h3><p>如果在 WinPE 映像中添加了多余的文件，可将其删除以减小映像大小并提高性能。 处理完映像后，可以提交更改并卸载映像。 然后将自定义的 WinPE 映像导出到 WinPE 文件夹中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dism /unmount-image /mountdir:c:\winpe_amd64\mount /commit</span><br><span class="line">dism /export-image /sourceimagefile:c:\winpe_amd64\media\sources\boot.wim /sourceindex:1 /DestinationImageFile:c:\winpe_amd64\mount\boot2.wim</span><br><span class="line">Del c:\winpe_amd64\media\sources\boot.wim</span><br><span class="line">Copy c:\winpe_amd64\mount\boot2.wim c:\winpe_amd64\media\sources\boot.wim</span><br></pre></td></tr></table></figure>

<h3 id="创建可启动的-WinPE-驱动器"><a href="#创建可启动的-WinPE-驱动器" class="headerlink" title="创建可启动的 WinPE 驱动器"></a>创建可启动的 WinPE 驱动器</h3><p>更新 WinPE 映像以包含所需的全部内容后，接下来可以制作可启动的 WinPE 驱动器。 在部署和映像工具环境中：</p>
<ol>
<li><p>将 USB 启动盘连接到技术人员电脑。</p>
</li>
<li><p>将 WinPE 复制到 WinPE 分区：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MakeWinPEMedia /UFD C:\winpe_amd64 P:</span><br></pre></td></tr></table></figure>

<p>其中，P: 是 WinPE 驱动器号。</p>
<p>出现提示后，按“Y” 以格式化该驱动器并安装 WinPE。</p>
</li>
</ol>
<h3 id="将参考电脑启动进入-WinPE"><a href="#将参考电脑启动进入-WinPE" class="headerlink" title="将参考电脑启动进入 WinPE"></a>将参考电脑启动进入 WinPE</h3><ol>
<li><p>将 USB 驱动器连接到参考设备。</p>
</li>
<li><p>关闭参考设备，然后启动进入 USB 驱动器。 通常可通过启动设备并快速按下某个键（例如 <strong>Esc</strong> 键或 <strong>Volume up</strong> 键）来执行此操作。</p>
<p> 备注</p>
<p>在某些设备上，可能需要进入启动菜单以选择 USB 驱动器。 如果可选择以 UEFI 模式还是 BIOS 模式启动，请选择 UEFI 模式。 若要了解详细信息，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/boot-to-uefi-mode-or-legacy-bios-mode?view=windows-10">启动到 UEFI 模式或传统 BIOS 模式</a>。 如果设备未从 USB 驱动器中启动，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/winpe-create-usb-bootable-drive?view=windows-10">WinPE：创建 USB 可引导驱动器</a>中的疑难解答提示。</p>
<p>WinPE 从命令行启动，然后运行 <code>wpeinit</code> 来设置系统。 这会需要几分钟时间。</p>
</li>
</ol>
<p>现在将此电脑启动到 Windows PE。 可以删除可启动的 USB 驱动器。</p>
<h2 id="自定义-Windows-映像"><a href="#自定义-Windows-映像" class="headerlink" title="自定义 Windows 映像"></a>自定义 Windows 映像</h2><p>为部署自定义 WinPE 映像后，接下来我们将了解如何让 Windows 映像为部署做好准备。 该过程类似于更改 WinPE 映像，但 Windows 还提供了其他许多自定义选项。</p>
<p>可对 Windows 映像进行脱机或联机自定义。 在启动进入 WinPE 后，从技术人员电脑或目标电脑对 Windows 映像 (install.wim) 进行脱机自定义。 在大多数情况下，脱机自定义是指从技术人员电脑执行的自定义。 在参考电脑启动进入审核模式后，可在其上进行联机自定义。</p>
<p>下表显示了可以在联机和脱机状态下进行的自定义。 在制造环境中，建议尽量在脱机状态下进行自定义。</p>
<table>
<thead>
<tr>
<th align="left">场景</th>
<th align="left">Offline</th>
<th align="left">联机</th>
</tr>
</thead>
<tbody><tr>
<td align="left">添加设备驱动程序</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">添加 Microsoft Store 应用</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">添加桌面 (win32) 应用</td>
<td align="left">-</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">添加语言包</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">删除默认语言包</td>
<td align="left">X</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">添加按需功能</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">添加最新累积更新</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">映像优化</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
<tr>
<td align="left">Microsoft Store 应用重复文件清理</td>
<td align="left">X</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">Microsoft Office</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
</tbody></table>
<h3 id="准备和装载-Windows-映像"><a href="#准备和装载-Windows-映像" class="headerlink" title="准备和装载 Windows 映像"></a>准备和装载 Windows 映像</h3><p><img src="https://pic1.zhimg.com/80/v2-08c52e8dd44cb1e48c11a7470093c7a3_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pic1.zhimg.com/80/v2-08c52e8dd44cb1e48c11a7470093c7a3_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>
<p>本部分介绍如何在技术人员电脑上装载 Windows 映像。 装载 Windows 映像的过程与我们前面用于装载 WinPE 映像的过程相同。 装载 Windows 映像 (install.wim) 时，我们可以访问另一个映像 WinRe.wim，它是支持恢复方案的映像。 同时更新 install.wim 和 WinRE.wim 有助于保持两个映像同步，从而确保恢复按预期进行。</p>
<p>在继续之前，请确保已创建 USB-B 驱动器。 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions-get-tools?view=windows-10">获取所需的工具</a>部分已介绍如何设置该驱动器。</p>
<h4 id="备份-Windows-映像文件"><a href="#备份-Windows-映像文件" class="headerlink" title="备份 Windows 映像文件"></a>备份 Windows 映像文件</h4><p>在处理 Windows 映像之前，需确保有一个备份副本，以防出现问题。 创建原始映像的副本：</p>
<p>首先将 install.wim 从 Windows 安装媒体复制到 USB-B。 Install.wim 包括家庭版和专业版映像。 我们将从 install.wim 中导出家庭版映像，然后在本次实验期间使用该映像。</p>
<ol>
<li><p>将 <em>USB-B</em> 插入到技术人员计算机。</p>
</li>
<li><p>从 Win Home 10 32-BIT&#x2F;X64 English OPK 装载 Windows 10 家庭版 .img 映像。</p>
</li>
<li><p>从装载的映像中，将 D:\sources\install.wim 复制到 C:\temp\lab\images。 （其中 D: 是装载的映像的驱动器号。）</p>
</li>
<li><p>从“开始”菜单打开“Windows 工具包”，然后以管理员身份打开“部署和映像工具环境”。</p>
</li>
<li><p>创建映像的副本以防出现问题。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy &quot;C:\temp\lab\Images\install.wim&quot; C:\temp\lab\Images\install-backup.wim</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 install.wim 中的家庭版（索引 2）导出为 basicimage.wim，并删除原始的 C:\temp\lab\images\install.wim：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dism /export-image /sourceimagefile:C:\temp\lab\images\install.wim /sourceindex:2 /destinationimagefile:C:\temp\lab\images\basicimage.wim</span><br><span class="line">Del C:\temp\lab\images\install.wim</span><br></pre></td></tr></table></figure>

<p>导出映像后，可以装载它。</p>
</li>
</ol>
<h4 id="装载-Windows-映像"><a href="#装载-Windows-映像" class="headerlink" title="装载 Windows 映像"></a>装载 Windows 映像</h4><p>创建装载目录并装载 basicimage.wim：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Md C:\mount\windows</span><br><span class="line">Dism /Mount-Wim /WimFile:C:\temp\lab\images\basicimage.wim /index:1 /MountDir:C:\mount\windows</span><br></pre></td></tr></table></figure>

<p>（其中 E:\ 是 USB-B 的驱动器号）</p>
<h4 id="装载-WinRE-映像"><a href="#装载-WinRE-映像" class="headerlink" title="装载 WinRE 映像"></a>装载 WinRE 映像</h4><p>如果系统无法成功启动进入 Windows，它将故障转移到 Windows 恢复环境 (WinRE)。 WinRE 可修复无法启动操作系统的常见问题。 WinRE 基于 WinPE，为了使其适合客户使用，你可以添加驱动程序、语言、Windows PE 可选组件，以及其他故障排除和诊断工具。</p>
<p>WinRE 映像包含在 Windows 10 映像中，最终将复制到目标电脑或设备上的 Windows RE 工具分区。 若要修改 WinRE 映像，需要装载 Windows 映像，然后在其中装载 WinRE 映像。 进行更改，卸载该 WinRE 映像，然后卸载该 Windows 映像。</p>
<p><img src="https://picx.zhimg.com/80/v2-6daa444377ac3cfa7f25a625ce8dc4aa_1440w.jpeg" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-6daa444377ac3cfa7f25a625ce8dc4aa_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"></p>
<p>如果将以下任何内容添加到映像，则还应该使用相同的更改来更新恢复映像：</p>
<ul>
<li>添加对启动非常关键的 .inf 格式驱动程序，例如显卡和存储驱动程序。</li>
<li>添加 Windows 的主要更新，例如 LCU。</li>
<li>添加新语言。不过，该操作并非始终可行，因为并非所有语言都具有 Windows RE 等效项。</li>
</ul>
<p> 备注</p>
<p>本实验假设你要在 install.wim 内部保留 winre.wim 以同步语言和驱动程序。如果你想在工厂车间节省一点时间，并且不反对单独管理这些映像，可以从映像中删除 winre.wim 并单独应用它。</p>
<ul>
<li><p>从已装载的映像装载 Windows RE 映像文件。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Md c:\mount\winre</span><br><span class="line">Dism /Mount-Wim /WimFile:C:\mount\windows\Windows\System32\Recovery\winre.wim /index:1 /MountDir:C:\mount\winre</span><br></pre></td></tr></table></figure>

<p> 提示</p>
<p>如果在指定目录下看不到 winre.wim，请使用以下命令将该文件设置为可见：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attrib -h -a -s C:\mount\windows\Windows\System32\Recovery\winre.wim</span><br></pre></td></tr></table></figure>

<p>故障排除：如果装载操作失败，请确保使用的是部署和映像工具环境中的 DISM。 不要将映像装载到受保护的文件夹，例如 User\Documents 文件夹。 如果 DISM 进程中断，请考虑暂时断开网络连接并禁用病毒防护。</p>
</li>
</ul>
<h3 id="脱机自定义"><a href="#脱机自定义" class="headerlink" title="脱机自定义"></a>脱机自定义</h3><p>装载映像后，可以开始自定义。 我们将介绍如何对 Windows 映像进行脱机自定义。 脱机自定义是在无需启动进入 Windows 安装的情况下可对已装载的映像进行的更改。 首先，我们逐步介绍如何从 Windows 映像添加（和删除）语言。</p>
<h4 id="关于语言"><a href="#关于语言" class="headerlink" title="关于语言"></a>关于语言</h4><p>本部分介绍如何将语言添加到 Windows 安装。 若要添加语言，需要使用语言包 ISO 中的语言包，并可以连接到 Internet 或能够访问按需功能 ISO。</p>
<p> 备注</p>
<ul>
<li>在应用主要更新之前添加语言。 主要更新包括修补程序、常规分发版本或 Service Pack。 如果你在以后添加语言，将需要重新安装这些更新。</li>
<li><strong>在应用前添加主要更新</strong>。 这些应用包括通用 Windows 应用和桌面应用程序。 如果在以后添加更新，则需要重新安装应用。 我们将稍后在实验 6：添加通用 Windows 应用中向你介绍如何添加它们。</li>
<li><strong>也向你的恢复映像添加你的语言</strong>：许多常用语言可以添加到你的恢复映像。 我们稍后将在实验 12：更新恢复映像中向你介绍如何添加它们。</li>
</ul>
<p>始终使用匹配 Windows 映像的语言和平台的语言包和 Features-On-Demand (FOD) 程序包。</p>
<p>按需功能 (FOD) 是随时可以添加的 Windows 功能包。 当用户需要一项新功能时，他们可以从 Windows 更新请求该功能包。 OEM 可以预安装这些功能，使得开箱即可在其设备上使用它们。</p>
<p>常见功能包括如手写识别等语言资源。 若要启用完整 Cortana 功能，需要其中一些功能。</p>
<p>下表显示适用于 Windows 10 的语言包和组件的类型：</p>
<table>
<thead>
<tr>
<th align="left">组件</th>
<th align="left">示例文件名</th>
<th align="left">依赖项</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">语言包</td>
<td align="left">Microsoft-Windows-Client-Language-Pack_x64_de-de.cab</td>
<td align="left">无</td>
<td align="left">UI 文本，包括基本 Cortana 功能。</td>
</tr>
<tr>
<td align="left">语言界面包</td>
<td align="left">LanguageExperiencePack.am-et.neutral.appx</td>
<td align="left">需要特定的完全本地化或部分本地化的语言包。 示例：ca-ES 需要 es-ES。</td>
<td align="left">UI 文本，包括基本 Cortana 功能。 若要了解详细信息，请参阅适用于 Windows 的语言包。</td>
</tr>
<tr>
<td align="left">基本</td>
<td align="left">Microsoft-Windows-LanguageFeatures-Basic-de-de-Package</td>
<td align="left">无</td>
<td align="left">拼写检查、文本预测、断词和断字（如果适用于该语言）。 你必须在添加以下任何组件之前添加此组件。</td>
</tr>
<tr>
<td align="left">字体</td>
<td align="left">Microsoft-Windows-LanguageFeatures-Fonts-Thai-Package</td>
<td align="left">无</td>
<td align="left">某些区域所需的字体。 例如，th-TH 需要泰语字体包。</td>
</tr>
<tr>
<td align="left">光学字符识别</td>
<td align="left">Microsoft-Windows-LanguageFeatures-OCR-de-de-Package</td>
<td align="left">基本</td>
<td align="left">识别和输出映像中的文本。</td>
</tr>
<tr>
<td align="left">手写内容识别</td>
<td align="left">Microsoft-Windows-LanguageFeatures-Handwriting-de-de-Package</td>
<td align="left">基本</td>
<td align="left">启用带有笔输入的设备的手写识别。</td>
</tr>
<tr>
<td align="left">文本转语音</td>
<td align="left">Microsoft-Windows-LanguageFeatures-TextToSpeech-de-de-Package</td>
<td align="left">基本</td>
<td align="left">启用文本到语音转换（由 Cortana 和“讲述人”使用）。</td>
</tr>
<tr>
<td align="left">语音识别</td>
<td align="left">Microsoft-Windows-LanguageFeatures-Speech-de-de-Package</td>
<td align="left">基本，文本到语音识别</td>
<td align="left">识别由“小娜”和 Windows 语音识别使用的语音输入</td>
</tr>
<tr>
<td align="left">零售演示体验</td>
<td align="left">Microsoft-Windows-RetailDemo-OfflineContent-Content-de-de-Package</td>
<td align="left">基本 (Basic) 包，加上与语言无关的零售演示包：Microsoft-Windows-RetailDemo-OfflineContent-Content-Package</td>
<td align="left"><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/retail-demo-experience">零售演示体验</a>。</td>
</tr>
</tbody></table>
<h4 id="添加或更改语言"><a href="#添加或更改语言" class="headerlink" title="添加或更改语言"></a>添加或更改语言</h4><p>在本部分，我们将语言和按需功能添加到 Windows 映像。 我们将添加德语 (de-de) 语言包，然后添加日语 (ja-jp) 语言。 日语是需要附加字体支持的语言示例。</p>
<p> 重要</p>
<p>如果在安装语言包之前安装的某个更新包含与语言相关的资源，则添加语言包时不会应用更新中特定于语言的更改。 需要重新安装该更新以应用特定于语言的更改。 若要避免重新安装更新，请在安装更新前安装语言包。</p>
<p>语言更新具有安装时需遵循的特定顺序。 例如，若要启用“小娜”，请依次安装：Microsoft-Windows-Client-Language-Pack、–Basic、–Fonts、–TextToSpeech、–Speech。 如果你不确定这些依赖关系，可将它们放置在同一文件夹中，然后使用 <code>DISM /Add-Package</code> 将它们全部添加。</p>
<p>确保使用的语言包和按需功能与所用映像的体系结构相匹配。 下面是构建 64 位系统的示例。</p>
<h5 id="复制语言文件"><a href="#复制语言文件" class="headerlink" title="复制语言文件"></a>复制语言文件</h5><p>装载语言包 ISO，并复制要添加到 <code>C:\temp\lab\LanguagePacks</code> 的语言的语言包 .cab 文件。 以下示例将使用德语和日语语言。</p>
<p>装载按需功能 ISO，并复制要添加到 <code>C:\temp\lab\LanguagePacks</code> 的语言的 LanguageFeatures .cab 文件。 以下示例将使用德语和日语语言。</p>
<ol>
<li><p>添加德语语言包和按需功能语言包。</p>
<p>使用 64 位 ISO 中的语言包和按需功能：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:C:\mount\windows /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-Client-Language-Pack_x64_de-de.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Basic-de-de-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-OCR-de-de-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Handwriting-de-de-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-TextToSpeech-de-de-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Speech-de-de-Package~31bf3856ad364e35~amd64~~.cab /packagepath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-RetailDemo-OfflineContent-Content-de-de-Package~31bf3856ad364e35~amd64~~.cab</span><br></pre></td></tr></table></figure>
</li>
<li><p>（可选）添加日语语言包和按需功能。</p>
<p>在 Windows 10 中，某些特定于语言的字体已划分到不同的语言 .cab 文件中。 在本部分，我们将添加 ja-JP 语言以及对日语字体的支持。</p>
<p>使用 64 位 ISO 中的语言包和按需功能：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:C:\mount\windows /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-Client-Language-Pack_x64_ja-jp.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Basic-ja-jp-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-OCR-ja-jp-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Handwriting-ja-jp-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-TextToSpeech-ja-jp-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Speech-ja-jp-Package~31bf3856ad364e35~amd64~~.cab /PackagePath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-LanguageFeatures-Fonts-Jpan-Package~31bf3856ad364e35~amd64~~.cab /packagepath:C:\Temp\Lab\LanguagePacks\Microsoft-Windows-RetailDemo-OfflineContent-Content-ja-jp-Package~31bf3856ad364e35~amd64~~.cab</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证语言包现在是否是已装载映像的一部分：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /get-packages /image:&quot;C:\mount\windows&quot;</span><br></pre></td></tr></table></figure>

<p>确保添加的语言出现在列表中。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Package Identity : Microsoft-Windows-Client-LanguagePack  ...  de-DE~10.0.17134.1</span><br><span class="line">State : Installed</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证按需功能是否在映像中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /get-capabilities /image:&quot;C:\mount\windows&quot;</span><br></pre></td></tr></table></figure>

<p>确保语言 FOD 出现在列表中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Capability Identity : Language.Basic~~~de-de~0.0.1.0</span><br><span class="line">State : Installed</span><br><span class="line">...</span><br><span class="line">Capability Identity : Language.Handwriting~~~de-de~0.0.1.0</span><br><span class="line">State : Installed</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="配置语言设置"><a href="#配置语言设置" class="headerlink" title="配置语言设置"></a>配置语言设置</h4><p>本部分介绍如何更改已装载的 Windows 映像的默认语言和时区。</p>
<ol>
<li><p>使用 DISM 设置映像的默认语言。 我们将默认语言设置为德语，因为在前面的步骤中我们已将该语言添加到映像中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:C:\mount\windows /Set-AllIntl:de-DE</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证所做的更改</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:C:\mount\windows /Get-Intl</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="设置默认时区"><a href="#设置默认时区" class="headerlink" title="设置默认时区"></a>设置默认时区</h4><p>可以使用 DISM 设置电脑的默认时区。 在此处，我们将设置时区。 有关可用时区的列表，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/default-time-zones?view=windows-10">默认时区</a>。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Set-TimeZone:&quot;W. Europe Standard Time&quot; /Image:&quot;C:\mount\windows&quot;</span><br></pre></td></tr></table></figure>

<h4 id="从映像中删除基础语言"><a href="#从映像中删除基础语言" class="headerlink" title="从映像中删除基础语言"></a>从映像中删除基础语言</h4><p>本部分介绍如何从 Windows 映像中删除语言。 这是可选步骤。</p>
<p>将映像设置为使用德语作为默认语言后，我们可以从映像中删除英语语言功能，使其成为非英语映像。 若要从映像中彻底删除 en-US，必须删除几个组件。</p>
<p> 警告</p>
<p>如果交付的是英语版电脑，请不要删除英语基础语言。</p>
<p>从 64 位映像中删除语言组件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:&quot;c:\mount\windows&quot; /remove-package /packagename:Microsoft-Windows-Client-LanguagePack-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:Microsoft-Windows-LanguageFeatures-Basic-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1 /packagename:Microsoft-Windows-LanguageFeatures-Handwriting-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1 /packagename:Microsoft-Windows-LanguageFeatures-OCR-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1 /packagename:Microsoft-Windows-LanguageFeatures-Speech-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1 /packagename:Microsoft-Windows-LanguageFeatures-TextToSpeech-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1 /packagename:Microsoft-Windows-RetailDemo-OfflineContent-Content-en-us-Package~31bf3856ad364e35~amd64~~10.0.17134.1</span><br></pre></td></tr></table></figure>

<p> 提示</p>
<p>故障排除：如果在运行这些命令时出错，请对失败的包再次尝试这些命令。 示例：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error: 0x800f0825</span><br><span class="line">Package Microsoft-Windows-LanguageFeatures-Basic-en-us-Package may have failed due to pending updates to servicing components in the image.</span><br></pre></td></tr></table></figure>

<p>如果命令完成但出错，请检查 DISM 日志文件： C:\windows\Logs\DISM\dism.log。</p>
<h4 id="将语言添加到-Windows-RE"><a href="#将语言添加到-Windows-RE" class="headerlink" title="将语言添加到 Windows RE"></a>将语言添加到 Windows RE</h4><p>下面介绍如何将语言添加到 WinRE。 将语言添加到 WinRE 可确保客户所需的语言在恢复方案中可用。 如果已将语言添加到 Windows 映像，请执行这些步骤。</p>
<p>WinRE 与 WinPE 使用相同的语言包。 可以在语言包 ISO 中找到这些语言包，还可以在路径为 <code>C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs\&lt;lang&gt;</code> 的 ADK 安装文件夹中找到特定于语言的 WinPE OC</p>
<p>若要完成本部分，请将语言包 ISO 中的语言包以及 <code>C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\WinPE_OCs</code> 中的 WinPE OC 复制到 <code>C:\Temp\Lab\LanguagePacks\RE\&lt;language&gt;</code>。</p>
<ol>
<li><p>添加德语语言包</p>
<p>使用 64 位版本的语言包和 WinPE 可选组件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\lp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\Temp\Lab\LanguagePacks\RE\de-deWinPE-Rejuv_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\\de-de\WinPE-EnhancedStorage_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-Scripting_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-SecureStartup_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-SRT_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-WDS-Tools_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-WMI_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-StorageWMI_de-de.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\de-de\WinPE-HTA_de-de.cab&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>（可选）将日语语言包和字体支持添加到 WinRE。 请注意，对于日语，我们将添加一个用于字体支持的附加 cab。</p>
<p>使用 64 位 ISO 中的语言包和 WinPE 可选组件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\lp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-Rejuv_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-EnhancedStorage_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-Scripting_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-SecureStartup_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-SRT_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-WDS-Tools_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-WMI_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-StorageWMI_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-HTA_ja-jp.cab&quot;</span><br><span class="line">Dism /image:C:\mount\winre /add-package /packagepath:&quot;C:\temp\lab\LanguagePacks\RE\ja-jp\WinPE-FontSupport-JA-JP.cab&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置 WinRE 的默认语言，以便与默认的 Windows 语言匹配。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:C:\mount\winre /Set-AllIntl:de-DE</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="从-WinRE-中删除基础语言（可选）"><a href="#从-WinRE-中删除基础语言（可选）" class="headerlink" title="从 WinRE 中删除基础语言（可选）"></a>从 WinRE 中删除基础语言（可选）</h4><p>类似于删除 install.wim 中的基础语言类似，我们也可以从 WinRE 中删除基础语言。</p>
<p>从 64 位映像中删除语言组件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /image:&quot;c:\mount\winre&quot; /remove-package /packagename:Microsoft-Windows-WinPE-LanguagePack-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-EnhancedStorage-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-HTA-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-Rejuv-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-Scripting-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-SecureStartup-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-SRT-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-StorageWMI-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-WDS-Tools-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1 /packagename:WinPE-WMI-Package~31bf3856ad364e35~amd64~en-US~10.0.17134.1</span><br></pre></td></tr></table></figure>

<h3 id="驱动程序"><a href="#驱动程序" class="headerlink" title="驱动程序"></a>驱动程序</h3><p>可以添加驱动程序，以确保 Windows 可以成功完成首次启动。 确保将驱动程序添加到正确的映像：</p>
<ul>
<li>DCHU 驱动程序：许多驱动程序包含一个信息文件（扩展名为 .inf）用于帮助安装驱动程序。 可以使用本部分所述的工具安装这些驱动程序。</li>
<li>对启动非常关键的驱动程序：有时可能需要将显卡和存储驱动程序添加到 Windows 映像（如本实验中所述）、Windows PE 映像和 WindowsRE 映像中。</li>
</ul>
<p>下面介绍如何以多种方式添加驱动程序。 如果你的硬件不需要任何额外的驱动程序，则无需添加任何驱动程序。</p>
<p> 提示</p>
<p>如果使用相同的硬件配置创建多个设备，可以通过在捕获 Windows 映像时维护驱动程序配置来缩短安装时间和首次启动时间。</p>
<h4 id="将驱动程序添加到-Windows-映像"><a href="#将驱动程序添加到-Windows-映像" class="headerlink" title="将驱动程序添加到 Windows 映像"></a>将驱动程序添加到 Windows 映像</h4><ol>
<li><p>添加包含 .inf 文件的单个驱动程序。 在此示例中，我们将使用名为 media1.inf 的驱动程序：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Driver /Image:&quot;C:\mount\windows&quot; /Driver:&quot;C:\Drivers\PnP.Media.V1\media1.inf&quot;</span><br></pre></td></tr></table></figure>

<p>其中“C:\Drivers\PnP.Media.V1\media1.inf”是驱动程序包中的基础 .inf 文件。</p>
</li>
<li><p>若要添加整个驱动程序文件夹，可以使用 &#x2F;Recurse 选项。 这会添加该文件夹及其所有子文件夹中的所有 .inf 驱动程序。</p>
<p> 警告</p>
<p>尽管 &#x2F;Recurse 很方便，但很容易使映像膨胀。 一些驱动程序包包含多个 .inf 驱动程序包，通常它们从同一文件夹共享负载文件。 在安装期间，每个 .inf 驱动程序包将展开到一个单独的文件夹，而每个文件夹中都有负载文件的副本。 我们已看到这样的情况：使用 &#x2F;Recurse 选项添加时，900MB 文件夹中的常见驱动程序导致映像大小增加了 10GB。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Driver /Image:&quot;C:\mount\windows&quot; /Driver:c:\drivers /Recurse</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证驱动程序是否为映像的一部分：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Get-Drivers /Image:&quot;C:\mount\windows&quot;</span><br></pre></td></tr></table></figure>

<p>检查包列表，验证其中是否包含已添加的驱动程序。</p>
</li>
</ol>
<h4 id="将驱动程序添加到-WinRE-映像"><a href="#将驱动程序添加到-WinRE-映像" class="headerlink" title="将驱动程序添加到 WinRE 映像"></a>将驱动程序添加到 WinRE 映像</h4><p>如果已将驱动程序添加到 Windows 映像，则还应该将其添加到 WinRE 映像。 将驱动程序添加到恢复映像可确保这些驱动程序在恢复方案中可用。 将驱动程序添加到 WinRE 映像与将驱动程序添加到普通 Windows 映像的过程相同。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Driver /Image:&quot;C:\mount\winre&quot; /Driver:&quot;C:\Drivers\PnP.Media.V1\media1.inf&quot; /LogPath=C:\mount\dism.log</span><br></pre></td></tr></table></figure>

<p> 备注</p>
<p>可以使用 &#x2F;recurse 选项添加整个驱动程序文件夹</p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p>装载映像后，可以添加 Windows 更新。 该过程类似于前面用于添加驱动程序的过程。</p>
<p>提醒：</p>
<ul>
<li>在应用主要更新之前添加语言。 主要更新包括修补程序、常规分发版本或 Service Pack。 如果你在以后添加语言，将需要重新添加这些更新。</li>
<li><strong>在应用前添加主要更新</strong>。 这些应用包括通用 Windows 应用和桌面应用程序。 如果你在以后添加更新，将需要重新添加这些应用。</li>
<li><strong>对于主要更新，还更新恢复映像</strong>：它们可以包括修补程序、常规分发版本、Service Pack 或其他预发布更新。 我们将稍后在实验 12：更新恢复映像中向你介绍如何更新它们。</li>
<li>如果需要服务堆栈更新 (SSU)，必须在应用最新或任何将来的常规发行版 (GDR) 之前应用 SSU。</li>
</ul>
<h4 id="将-Windows-更新添加到映像"><a href="#将-Windows-更新添加到映像" class="headerlink" title="将 Windows 更新添加到映像"></a>将 Windows 更新添加到映像</h4><p>使用 DISM 应用最新的服务堆栈更新 (SSU) 和常规发行版 (GDR) 以及任何必备的 KB 更新。 可在以下位置找到 KB 更新：</p>
<p>GDR：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/release-information/">https://aka.ms/win10releaseinfo</a></p>
<p>SSU：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/get-started/what-s-new-in-windows">https://msdn.microsoft.com/windows/hardware/commercialize/manufacture/whats-new-in-windows-manufacturing</a></p>
<p>KB 文件：<a target="_blank" rel="noopener" href="https://catalog.update.microsoft.com/">https://catalog.update.microsoft.com</a></p>
<p> 重要</p>
<p>如果在安装语言包之前安装的更新（修补程序、常规发行版 [GDR] 或服务包 [SP]）包含与语言相关的资源，则添加语言包时不会应用更新中特定于语言的更改。 需要重新安装该更新以应用特定于语言的更改。 若要避免重新安装更新，请在安装更新前安装语言包。</p>
<ol>
<li><p>获取 Windows 更新包。 例如，<a target="_blank" rel="noopener" href="https://www.catalog.update.microsoft.com/Search.aspx?q=Cumulative+update">从 Microsoft 更新目录获取在 Windows 10 更新历史记录中列出的最新累积更新</a>。 将 .msu 文件更新提取到某个文件夹，例如 E:\updates\windows10.0-kb4016240-x64_0e60aebeb151d4b3598e4cfa9b4ccb1fc80e6e4d.msu。 确保该更新与所用映像的体系结构匹配。</p>
<p>若要了解详细信息，请参阅 <a target="_blank" rel="noopener" href="https://myoem.microsoft.com/oem/myoem/product/winemb/pages/comm-ms-updt-ctlg-trnstn.aspx.%E3%80%82">https://myoem.microsoft.com/oem/myoem/product/winemb/pages/comm-ms-updt-ctlg-trnstn.aspx.。</a></p>
</li>
<li><p>使用 <code>dism /add-package</code> 将 msu 添加到已装载的映像。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:C:\mount\windows /PackagePath:&quot;E:\updates\windows10.0-kb4000001-x64.msu&quot;</span><br></pre></td></tr></table></figure>

<p>还可以在同一命令中添加多个更新：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:C:\mount\windows /PackagePath:&quot;E:\updates\windows10.0-kb4000001-x64.msu&quot; /PackagePath:&quot;E:\updates\windows10.0-kb0000002-x64.msu&quot;</span><br></pre></td></tr></table></figure>

<p> 备注</p>
<p>每个包通常是一个新的 KB，它会递增 Windows 的修订版本号。 可在以下注册表项中找到 Windows 的修订版本号：<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\UBR</code></p>
</li>
<li><p>锁定更新以确保它在恢复期间可还原。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /Cleanup-Image /Image=C:\mount\windows /StartComponentCleanup /ScratchDir:C:\Temp</span><br></pre></td></tr></table></figure>
</li>
<li><p>验证更新是否包含在映像中。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:C:\mount\windows /Get-Packages</span><br></pre></td></tr></table></figure>

<p>查看程序包结果列表，验证该列表是否包含该程序包。 例如：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Package Identity : Package_for_RollupFix~31bf3856ad364e35~amd64~~15063.250.1.1</span><br><span class="line">State : Installed</span><br><span class="line">Release Type : Security Update</span><br><span class="line">Install Time : 04/29/2017 6:26 PM</span><br><span class="line">The operation completed successfully.</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="将更新包添加到-WinRE"><a href="#将更新包添加到-WinRE" class="headerlink" title="将更新包添加到 WinRE"></a>将更新包添加到 WinRE</h4><p>本部分介绍如何将更新添加到 WinRE 映像。</p>
<p> 重要</p>
<p>除了 Windows 映像之外，还必须对 WinRE 映像应用累积更新。 由于更新是累积性的，在安装新的更新后可以删除旧的更新。 稍后我们在本实验中进行的 WinRE 优化将删除不必要的更新，这可以防止 WinRE 映像不断增大。</p>
<p>若要将上一部分中下载的更新应用于 WinRE 映像，必须运行 <code>dism /add-package</code> 以将更新应用于装载的 WinRE 映像。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-Package /Image:C:\mount\winre /PackagePath:&quot;E:\updates\windows10.0-kb4000001-x64.msu&quot;</span><br></pre></td></tr></table></figure>

<h3 id="功能和应用"><a href="#功能和应用" class="headerlink" title="功能和应用"></a>功能和应用</h3><h4 id="按需功能"><a href="#按需功能" class="headerlink" title="按需功能"></a>按需功能</h4><p>将按需功能 (FOD) 添加到 Windows 映像。 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/features-on-demand-v2--capabilities?view=windows-10">按需功能</a> 是可以选择预安装的功能。 可在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/features-on-demand-non-language-fod?view=windows-10">此处</a>查看可用 FOD 列表和预装建议。</p>
<p>下面介绍如何预装 .Net Framework 按需功能。</p>
<p>注意：虽然可以使用 &#x2F;add-package 命令添加 FOD，但我们建议使用带 &#x2F;Add-Capability 选项的 DISM。</p>
<ol>
<li><p>装载按需功能 ISO</p>
</li>
<li><p>在技术人员电脑上，使用 DISM 获取映像中的可用 FOD 列表：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:C:\mount\windows /get-capabilities</span><br></pre></td></tr></table></figure>

<p>这会显示可用功能的列表。</p>
</li>
<li><p>添加 .NET Framework。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:C:\mount\windows /add-capability /capabilityname:NetFX3~~~~ /Source:E:</span><br></pre></td></tr></table></figure>

<p>其中 E: 是装载的 FOD ISO。</p>
</li>
</ol>
<p>.NET Framework 现已添加到映像。</p>
<h4 id="“应用”"><a href="#“应用”" class="headerlink" title="“应用”"></a>“应用”</h4><p>本部分介绍如何处理应用，包括更新后如何重新安装内置应用、如何添加 Microsoft Store 应用，以及如何添加 Microsoft Office。</p>
<p>本部分继续使用装载的 Windows 映像。 如果尚未装载该映像，请装载。</p>
<p>提醒：请仅在依次安装语言和更新后才安装应用。</p>
<h4 id="重新安装内置应用"><a href="#重新安装内置应用" class="headerlink" title="重新安装内置应用"></a>重新安装内置应用</h4><p>将语言和更新添加到映像后，必须重新安装 Windows 随附的应用。 这可以确保应用能够正常运行并包含已添加到映像中的语言。 若要重新安装这些应用，需要使用应用更新 OPK 或内置应用 ISO。</p>
<ol>
<li>将内置应用 ISO 提取到 C:\temp\lab\apps\inbox\amd64</li>
<li>运行 <code>E:\apps\ReinstallInboxApps-x64.bat</code> 脚本。</li>
</ol>
<p>应用现已准备好使用你的映像。</p>
<h4 id="添加-Microsoft-Store-应用"><a href="#添加-Microsoft-Store-应用" class="headerlink" title="添加 Microsoft Store 应用"></a>添加 Microsoft Store 应用</h4><p>若要完成本部分，需要使用应用更新 OPK 或内置应用 ISO。 无论你使用其中的哪一个，我们在以下步骤中都将其称为“应用更新 OPK”。</p>
<ol>
<li><p>使用 DISM 添加在步骤 1 中提取的文件中的 HEVC 编解码器 .appx：</p>
</li>
<li><p>安装 HEVC .appx：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /Add-ProvisionedAppxPackage /Image:c:\mount\windows /PackagePath:&quot;C:\temp\lab\apps\amd64\Microsoft.HEVCVideoExtension_8wekyb3d8bbwe.x64.appx&quot; /licensepath:&quot;C:\temp\lab\apps\inbox\amd64\Microsoft.HEVCVideoExtension_8wekyb3d8bbwe.x64.xml&quot; /DependencyPackagePath:&quot;C:\temp\lab\apps\inbox\amd64\Microsoft.VCLibs.x64.14.00.appx&quot; /DependencyPackagePath:&quot;C:\temp\lab\apps\inbox\amd64\Microsoft.VCLibs.x86.14.00.appx&quot;</span><br></pre></td></tr></table></figure>

<p> 备注</p>
<p>请同时包含 x86 和 x64 版本的依赖包。</p>
</li>
<li><p>使用 <code>DISM /Add-ProvisionedAppxPackage</code> 将任何其他应用添加到映像。</p>
</li>
<li><p>验证是否已安装应用：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:&quot;C:\mount\windows&quot; /Get-ProvisionedAppxPackages</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="安装不会固定到“开始”菜单的-Microsoft-Store-应用"><a href="#安装不会固定到“开始”菜单的-Microsoft-Store-应用" class="headerlink" title="安装不会固定到“开始”菜单的 Microsoft Store 应用"></a>安装不会固定到“开始”菜单的 Microsoft Store 应用</h4><p>若要完成本部分，至少需要准备好两个要添加到映像的应用。 如果没有任何已签名的应用，可以跳到下一部分。</p>
<p>Windows 10 版本 1803 中的新增功能：现在可以安装不固定到“开始”菜单的 Microsoft Store 应用。 若要安装某个应用但不固定它，请在安装该应用时结合 <code>/region</code> 开关使用 <code>DISM /Add-ProvisionedAppxPackage</code>。 稍后在本实验中创建自定义的“开始”菜单时，可以从“开始”菜单中排除已安装的应用。</p>
<ol>
<li><p>收集应用进行安装</p>
</li>
<li><p>安装应用，并使用 <code>/region</code> 选项为每个应用指定区域。 可以指定多个区域，使用 <code>;</code> 分隔各个区域即可。 本实验稍后会介绍如何在 LayoutModification.xml 中使用 <code>/region</code>：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dism /Add-ProvisionedAppxPackage /PackagePath:app1.appxbundle /region=&quot;all&quot;</span><br><span class="line">Dism /Add-ProvisionedAppxPackage /PackagePath:app2.appxbundle /region=&quot;US&quot;</span><br></pre></td></tr></table></figure>

<p>注意：如果应用具有依赖项，请使用 <code>/DependencyPackagePath</code> 将依赖项包含在命令中。 与上一部分中的示例类似，应用通常依赖于 .NET.CoreRuntime 和 .VCLibs，但如果应用不共享这些依赖项，请不要将这些依赖项包含在命令中。</p>
</li>
</ol>
<h4 id="优化已安装的应用"><a href="#优化已安装的应用" class="headerlink" title="优化已安装的应用"></a>优化已安装的应用</h4><p>Windows 10 版本 1803 中的新增功能：在安装应用后，可以通过运行 <code>DISM /Optimize-ProvisionedAppxPackages</code> 来减少应用的磁盘使用量。 只能针对脱机映像运行此命令：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM.exe /Image:&quot;C:\mount\windows&quot; /Optimize-ProvisionedAppxPackages</span><br></pre></td></tr></table></figure>

<h4 id="预装-Microsoft-Office"><a href="#预装-Microsoft-Office" class="headerlink" title="预装 Microsoft Office"></a>预装 Microsoft Office</h4><h5 id="相关集"><a href="#相关集" class="headerlink" title="相关集"></a>相关集</h5><p>Office 应用是作为一起安装和维护的一组应用交付的。 Office 的主包是一组共享代码，每个 Office 应用（例如 Word、Excel 和 PowerPoint）将作为可选的包安装。 这些包是以支持所有 Store 应用语言的 appxbundle 文件形式交付的。</p>
<table>
<thead>
<tr>
<th align="left">应用</th>
<th align="left">包 ID</th>
<th align="left">文件</th>
</tr>
</thead>
<tbody><tr>
<td align="left">共享代码和所需应用（用户不可见）</td>
<td align="left">Microsoft.Office.Desktop_8wekyb3d8bbwe</td>
<td align="left">shared.appxbundle、shared_License1.xml</td>
</tr>
<tr>
<td align="left">Access</td>
<td align="left">Microsoft.Office.Desktop.Access_8wekyb3d8bbwe</td>
<td align="left">access.appxbundle、access_License1.xml</td>
</tr>
<tr>
<td align="left">Excel</td>
<td align="left">Microsoft.Office.Desktop.Excel_8wekyb3d8bbwe</td>
<td align="left">excel.appxbundle、excel_License1.xml</td>
</tr>
<tr>
<td align="left">Outlook</td>
<td align="left">Microsoft.Office.Desktop.Outlook_8wekyb3d8bbwe</td>
<td align="left">outlook.appxbundle、outlook_License1.xml</td>
</tr>
<tr>
<td align="left">PowerPoint</td>
<td align="left">Microsoft.Office.Desktop.PowerPoint_8wekyb3d8bbwe</td>
<td align="left">powerpoint.appxbundle、powerpoint_License1.xml</td>
</tr>
<tr>
<td align="left">发布者</td>
<td align="left">Microsoft.Office.Desktop.Publisher_8wekyb3d8bbwe</td>
<td align="left">publisher.appxbundle、publisher_License1.xml</td>
</tr>
<tr>
<td align="left">Word</td>
<td align="left">Microsoft.Office.Desktop.Word_8wekyb3d8bbwe</td>
<td align="left">word.appxbundle、word_License1.xml</td>
</tr>
</tbody></table>
<h5 id="将-Office-应用添加到映像"><a href="#将-Office-应用添加到映像" class="headerlink" title="将 Office 应用添加到映像"></a>将 Office 应用添加到映像</h5><p>若要将 Office 应用添加到映像，请结合 <code>/Add-ProvisionedAppxPackage</code> 选项使用 DISM。 此选项还要求提供所要添加的每个应用的以下信息：</p>
<ul>
<li><code>/PackagePath</code>：仅用于指定共享代码包的 .appxbundle 文件的路径。</li>
<li><code>/OptionalPackagePath</code>：用于指定单个应用（例如 Word 或 Excel）的 .appxbundle 文件的路径。</li>
<li><code>/LicensePath</code>：用于指定单个应用的 _License1.xml 文件的路径。 需要为共享包和每个可选应用包指定此参数。</li>
</ul>
<ol>
<li><p>将 Office OPK 提取到 C:\temp\lab\apps。</p>
</li>
<li><p>使用 DISM 将所有 Office 应用添加到脱机映像。 以下示例假定 appxbundle 和 license xml 文件位于 USB-B (D:) 上的子目录中。 此外，该示例未使用 &#x2F;region 开关，因为我们希望 Office 显示在“所有应用”列表中，同时显示为“开始”菜单磁贴。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /Image:C:\mount\windows /Add-ProvisionedAppxPackage /PackagePath=&quot;C:\temp\lab\apps\Office Apps\shared.PreinstallKit\shared.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\excel.PreinstallKit\excel.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\powerpoint.PreinstallKit\powerpoint.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\word.PreinstallKit\word.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\outlook.PreinstallKit\outlook.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\publisher.PreinstallKit\publisher.appxbundle&quot; /OptionalPackagePath=&quot;C:\temp\lab\apps\Office Apps\access.PreinstallKit\access.appxbundle&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\shared.PreinstallKit\shared_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\excel.PreinstallKit\excel_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\powerpoint.PreinstallKit\powerpoint_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\word.PreinstallKit\word_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\outlook.PreinstallKit\outlook_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\publisher.PreinstallKit\publisher_license1.xml&quot; /LicensePath=&quot;C:\temp\lab\apps\Office Apps\access.PreinstallKit\access_License1.xml&quot;</span><br></pre></td></tr></table></figure>

<p> 提示</p>
<p>需要为共享包以及要安装的每个应用指定 appxbundle 和许可证包。</p>
<p> 备注</p>
<p>用于在审核模式（联机而不是脱机模式）下添加 Office 应用的命令与此相同，不过需要将 &#x2F;Image:C:\mount\windows 替换为 &#x2F;online。</p>
<p>有关语言支持的说明</p>
<p>使用 DISM 安装 Office 时，会自动添加与 Windows 映像中语言匹配的 Office 语言文件。</p>
<ul>
<li>默认情况下，Office 将使用 Windows 的 UI 语言。 若要配置 Windows UI 语言，请参阅“DISM 语言和国际服务命令行选项”。</li>
<li>无法添加不包含在 Windows 映像中的其他 Office 语言。</li>
<li>将为每种 Windows 语言安装 Office 的显示和校对资源。</li>
<li>Windows 支持的某些语言不受 Office 的支持 - 对于这种情况，Office 将使用最接近的可用语言（例如，对于 es-mx，它会尝试使用 es-es）。</li>
<li>可以在 Windows“设置”&gt;“时间和语言”&gt;“语言”中找到已安装的 Windows 语言。</li>
</ul>
</li>
<li><p>验证是否已安装 Office：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:&quot;C:\mount\windows&quot; /Get-ProvisionedAppxPackages</span><br></pre></td></tr></table></figure>

<p>其中 C 是包含该映像的驱动器的驱动器号。</p>
<p>查看生成的包列表，确认该列表是否包含 Office 应用，例如：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Displayname : Microsoft.Office.Desktop.Access</span><br><span class="line">Version : 16000.8528.2136.0</span><br><span class="line">Architechture : neutral</span><br><span class="line">ResourceID : ~</span><br><span class="line">PackageName : Microsoft.Office.Desktop.Access_16000.8528.2136.0_neutral_~_8wekyb3d8bbwe</span><br><span class="line">Regions : None</span><br><span class="line"></span><br><span class="line">Displayname : Microsoft.Office.Desktop.Excel</span><br><span class="line">Version : 16000.8528.2136.0</span><br><span class="line">Architechture : neutral</span><br><span class="line">ResourceID : ~</span><br><span class="line">PackageName : Microsoft.Office.Desktop.Excel_16000.8528.2136.0_neutral_~_8wekyb3d8bbwe</span><br><span class="line">Regions : None</span><br><span class="line"></span><br><span class="line">Displayname : Microsoft.Office.Desktop.Outlook</span><br><span class="line">Version : 16000.8528.2136.0</span><br><span class="line">Architechture : neutral</span><br><span class="line">ResourceID : ~</span><br><span class="line">PackageName : Microsoft.Office.Desktop.Outlook_16000.8528.2136.0_neutral_~_8wekyb3d8bbwe</span><br><span class="line">Regions : None</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>若要让应用显示在“开始”屏幕上，请按照下一部分的步骤操作：配置“开始”磁贴和任务栏固定应用。</p>
<p>若要完成 Office 安装，需要卸载映像并提交更改，我们将在本实验最后完成所有自定义后执行此操作。</p>
</li>
</ol>
<h3 id="修改“开始”菜单布局"><a href="#修改“开始”菜单布局" class="headerlink" title="修改“开始”菜单布局"></a>修改“开始”菜单布局</h3><h4 id="Windows-10-版本-1803-中的新增功能"><a href="#Windows-10-版本-1803-中的新增功能" class="headerlink" title="Windows 10 版本 1803 中的新增功能"></a>Windows 10 版本 1803 中的新增功能</h4><p>现在，可将应用固定到“所有应用”列表，而不必固定为“开始”菜单磁贴。 这是通过新的“区域”开关实现的（如上一部分所述）。 在上一部分，我们已将三个应用添加到映像：App1、App2 和 Office。 在本实验中，我们将在 LayoutModification.xml 中省略 App1，以确保 App1 只显示在“所有应用”列表中，而不显示为“开始”菜单磁贴。 我们还将在 LayoutModification.xml 中包含 App2，以演示即使在将应用添加到映像时使用了“region”开关，如果该应用包含在 LayoutModification.xml 文件中的话，它也仍会显示在“开始”菜单中。 换言之，LayoutModification.xml 文件的优先级更高。</p>
<h4 id="“开始”菜单"><a href="#“开始”菜单" class="headerlink" title="“开始”菜单"></a>“开始”菜单</h4><p>如果不创建 LayoutModification.xml 文件并使用“无人参与的开始菜单”设置，Windows 将使用 Unattend 文件中指定的前 12 个 <code>SquareTiles</code> 或 <code>DesktoporSquareTiles</code> 设置。 然后，系统会在“开始”菜单末尾的新建组中自动放置这些磁贴。 前六个磁贴放置在第一个 OEM 组中，第二组六个磁贴放置在第二个 OEM 组中。 如果在 Unattend 文件中指定了 <code>OEMName</code>，则此元素的值将用于命名所要创建的 OEM 组。</p>
<p> 备注</p>
<p>如果用户使用内置恢复工具重置电脑，“开始”布局和任务栏固定可能丢失。 为确保这些设置保留在设备上，请将恢复映像与 Windows 映像一起更新。</p>
<p>Windows 10 中的“开始”屏幕磁贴布局允许 OEM 将包括 Web 链接、辅助磁贴、经典 Windows 应用程序和通用 Windows 应用在内的磁贴附加到默认“开始”屏幕布局。 OEM 无需重复大量工作就可以使用此布局，使它能适用于多个地区或市场。 另外，OEM 可以向系统区域中经常使用的应用部分添加最多 3 个默认应用，这会提供系统驱动的列表（包括重要或经常访问的系统位置和最近安装的应用）。</p>
<p>若要利用这些新功能并获得 Windows 10 的最可靠且完整的“开始”菜单自定义体验，请考虑创建 LayoutModification.xml 文件。 此文件指定在“开始”屏幕中应如何排列 OEM 磁贴。 有关如何自定义新“开始”菜单布局的详细信息，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/customize-start-layout">自定义 Windows 10“开始”菜单布局</a>。</p>
<p>开始：使用包含在 USB-B 文件中的示例 layoutmodification.xml。 对于本实验部分，请从此文件开始。 可以在 <code>USB-B\StartLayout\layoutmodification.xml</code> 中找到它。</p>
<p>若要详细了解 layoutmodification.xml，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows/configuration/start-layout-xml-desktop#layoutmodification-xml">LayoutModification XML</a>。</p>
<h4 id="关于“开始”菜单布局"><a href="#关于“开始”菜单布局" class="headerlink" title="关于“开始”菜单布局"></a>关于“开始”菜单布局</h4><ol>
<li><p>在 <code>RequiredStartGroups</code> 元素中使用可选的 <code>Region</code> 属性可为不同的区域使用不同的布局。 <code>Region</code> 值必须等于双字母国家&#x2F;地区代码，如果指定多个区域，请用竖线“|”分隔符分隔各个区域。 组中列出的区域与在使用 <code>/region</code> 选项将应用添加到映像时指定的区域相关。 如果 Windows 设备的国家&#x2F;地区设置与 <code>RequiredStartGroups</code> 匹配，则 <code>RequiredStartGroups</code> 中排列的磁贴将应用于“开始”菜单。 如果指定一个与区域无关的（或没有可选区域属性的）<code>RequiredStartGroups</code>，则与区域无关的 <code>RequiredStartGroups</code> 将应用于“开始”菜单。</p>
<p>在 layoutmodification.xml 中，将区域添加到 <code>RequiredStartGroups</code>：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;RequiredStartGroups Region=&quot;DE|ES|FR|GB|IT|US&quot;&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 AppendGroup 中指定要添加的磁贴。 OEM 最多可以添加两个 AppendGroup。 以下示例显示名为“Fabrikam Group 1”和“Fabrikam Group 2”的两个组，其中包含设备所在国家&#x2F;地区与在 Region（在本例中，区域为德国、西班牙、法国、英国、意大利和美国）中指定的国家&#x2F;地区匹配时要应用的磁贴。 每个组均包含三个磁贴和需要使用的各种元素，具体取决于要固定到“开始”的磁贴。</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LayoutModificationTemplate</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/Start/2014/LayoutModification&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:defaultlayout</span>=<span class="string">&quot;http://schemas.microsoft.com/Start/2014/FullDefaultLayout&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:start</span>=<span class="string">&quot;http://schemas.microsoft.com/Start/2014/StartLayout&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">Version</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RequiredStartGroupsCollection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">RequiredStartGroups</span></span></span><br><span class="line"><span class="tag">  <span class="attr">Region</span>=<span class="string">&quot;DE|ES|FR|GB|IT|US&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">AppendGroup</span> <span class="attr">Name</span>=<span class="string">&quot;Fabrikam Group 1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">start:DesktopApplicationTile</span></span></span><br><span class="line"><span class="tag">        <span class="attr">DesktopApplicationID</span>=<span class="string">&quot;Microsoft.Windows.Explorer&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Size</span>=<span class="string">&quot;2x2&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Row</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Column</span>=<span class="string">&quot;4&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">AppendGroup</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">AppendGroup</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Name</span>=<span class="string">&quot;Fabrikam Group 2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">start:Tile</span> <span class="attr">AppUserModelID</span>=<span class="string">&quot;Microsoft.MicrosoftEdge_8wekyb3d8bbwe!MicrosoftEdge&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Size</span>=<span class="string">&quot;2x2&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Row</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">Column</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">AppendGroup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RequiredStartGroups</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RequiredStartGroupsCollection</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在前面的“添加 Microsoft Store 应用”部分，我们要求你使用 &#x2F;region 开关安装了两个应用：App1 和 App2。 由于我们为这两个应用都包含了 <code>/region</code> 开关，因此两者都会安装并显示在“所有应用”列表中。 但是，要使 App2 也显示为“开始”菜单磁贴，请在 LayoutModification.xml 文件的第二个 <code>&lt;AppendGroup&gt;</code> 中添加以下行，例如：</p>
<p>由于我们在预配 App2 时已将区域设置为“US”，因此，此处也应在 LayoutModification.xml 中将区域设置为“US”，以确保 App2 仅在美国映像中显示为“开始”菜单磁贴。 因此，请确保 <code>&lt;RequiredStartGroups&gt;</code> 区域参数设置如下：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RequiredStartGroups</span> <span class="attr">Region</span>=<span class="string">&quot;US&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AppendGroup</span> <span class="attr">Name</span>=<span class="string">&quot;MyGroup&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">start:Tile</span> <span class="attr">AppUserModelID</span>=<span class="string">&quot;App2!App&quot;</span> <span class="attr">Size</span>=<span class="string">&quot;2x2&quot;</span> <span class="attr">Row</span>=<span class="string">&quot;2&quot;</span> <span class="attr">Column</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">AppendGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或者，至少应包含“US”，例如：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RequiredStartGroups</span> <span class="attr">Region</span>=<span class="string">&quot;DE|US|JA&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AppendGroup</span> <span class="attr">Name</span>=<span class="string">&quot;MyGroup&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">start:Tile</span> <span class="attr">AppUserModelID</span>=<span class="string">&quot;App2!App&quot;</span> <span class="attr">Size</span>=<span class="string">&quot;2x2&quot;</span> <span class="attr">Row</span>=<span class="string">&quot;2&quot;</span> <span class="attr">Column</span>=<span class="string">&quot;0&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">AppendGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 Microsoft Office“开始”菜单磁贴。 这是参与 Jumpstart 计划的 OEM 所要满足的要求。</p>
<p>可以在 Windows 10“开始”菜单中显示 Word、PowerPoint 和 Excel 的磁贴。 磁贴显示在 Microsoft 应用的指定区域（在下图中显示在左上角）。 可以在左侧的“应用”列表中访问所有其他应用。</p>
<p>将以下内容添加到 LayoutModification.xml 文件以添加磁贴：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">AppendOfficeSuite</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">AppendOfficeSuiteChoice</span> <span class="attr">Choice</span>=<span class="string">&quot;DesktopBridgeSubscription&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p> 备注</p>
<p>若要添加桌面应用，请使用 start:DesktopApplicationTile 标记。 如果你知道应用的应用程序用户模型 ID，请使用该 ID 来标识它。 否则，如果你固定的磁贴需要 .url 或 .lnk 文件，请将这些文件添加到以下传统“开始”菜单目录：</p>
<ul>
<li>%APPDATA%\Microsoft\Windows\Start Menu\Programs\</li>
<li>%ALLUSERSPROFILE%\Microsoft\Windows\Start Menu\Programs\</li>
</ul>
<p>示例：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copy E:\StartLayout\Bing.url  &quot;C:\mount\Windows\ProgramData\Microsoft\Windows\Start Menu\Programs&quot;</span><br><span class="line">Copy E:\StartLayout\Paint.lnk &quot;C:\mount\Windows\ProgramData\Microsoft\Windows\Start Menu\Programs&quot;</span><br><span class="line">Copy E:\StartLayout\Bing.url  &quot;C:\mount\Windows\Users\All Users\Microsoft\Windows\Start Menu\Programs&quot;</span><br><span class="line">Copy E:\StartLayout\Paint.lnk &quot;C:\mount\Windows\Users\All Users\Microsoft\Windows\Start Menu\Programs&quot;</span><br></pre></td></tr></table></figure>

<ol>
<li>将“开始”菜单布局文件保存为 layoutmodification.xml。</li>
<li>将保存的文件复制到装载的映像中的 <code>C:\Mount\Windows\Users\Default\Appdata\Local\Microsoft\Windows\Shell</code> 文件夹。 如果该文件夹中已存在 layoutmodification.xml 文件，请将现有文件替换为新文件。</li>
</ol>
<h3 id="添加许可协议和信息文件"><a href="#添加许可协议和信息文件" class="headerlink" title="添加许可协议和信息文件"></a>添加许可协议和信息文件</h3><h4 id="添加特定于-OEM-的许可证"><a href="#添加特定于-OEM-的许可证" class="headerlink" title="添加特定于 OEM 的许可证"></a>添加特定于 OEM 的许可证</h4><p>本部分介绍 OEM 如何在 OOBE 期间添加自己的许可条款。</p>
<p> 备注</p>
<p>如果包含许可条款，OEM 必须将预安装到电脑的各种语言版本的许可条款包含在内。 许可条款文本必须是 .rtf 文件，并在同一文件夹中提供具有匹配名称的 .html 文件。 有关许可文件的详细信息，请参阅 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/oem-license">OEM 许可条款</a>。</p>
<p>若要开始添加许可条款，必须为许可文件创建文件夹，然后将 OOBE 配置为在首次启动时显示许可条款。</p>
<ol>
<li><p>在以下目录下根据你的系统语言创建文件夹：C:\mount\windows\Windows\System32\oobe\info\default\</p>
</li>
<li><p>将 C:mount\windows\Windows\System32\oobe\info\default\ 目录下的每个文件夹命名为与语言对应的语言十进制标识符。 针对 Windows 映像中的每种语言包执行此步骤。</p>
<p>注意：请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/available-language-packs-for-windows?view=windows-10">此链接</a>以查看对应语言的语言十进制标识符完整列表。</p>
<p>例如，如果美国英语 (en-us) 和德语 (de-de) 语言包已添加到 Windows 映像，请在 C:\mount\windows\Windows\System32\oobe\info\default\ 中添加名为“1033”（表示美国英语语言）的文件夹。 然后，在同一 C:\mount\windows\Windows\System32\oobe\info\default\ 目录下添加名为“1031”（德语语言）的文件夹。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MD c:\mount\windows\windows\system32\oobe\info\default\1031</span><br><span class="line">MD c:\mount\windows\windows\system32\oobe\info\default\1033</span><br></pre></td></tr></table></figure>
</li>
<li><p>为映像中的每种语言创建一个许可条款 .rtf 文件，并将其复制到特定于语言的 oobe 文件夹。</p>
<p>例如：将英语 agreement.rtf 文件移到 C:\mount\windows\Windows\System32\oobe\info\default\1033\ 目录，将德语 agreement.rtf 文件移到 C:\mount\windows\Windows\System32\oobe\info\default\1031。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy E:\resources\english-agreement.rtf c:\mount\windows\windows\system32\oobe\info\default\1033\agreement.rtf</span><br><span class="line">copy E:\resources\german-agreement.rtf c:\mount\windows\windows\system32\oobe\info\default\1031\agreement.rtf</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开文本编辑器并创建 .html 版本的许可条款。 将这些条款保存到 .rtf 版本所在的同一文件夹。 可以使用 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/oem-license">OEM 许可条款</a>中的 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/oem-license#eula-example">EULA 示例</a>来创建示例文件。 EULA 文件的名称应该相同，只是扩展名不同。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\mount\windows\windows\system32\oobe\info\default\1033\agreement.html  (English version)</span><br><span class="line">C:\mount\windows\windows\system32\oobe\info\default\1031\agreement.html  (German version)</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 oobe.xml 文件以指定许可协议 .rtf 文件路径。 Windows 将自动查找随附的 .html 文件。 下面是一个示例 oobe.xml，其路径为 USB-B\ConfigSet\oobe.xml</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">FirstExperience</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">oobe</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">oem</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">eulafilename</span>&gt;</span>agreement.rtf<span class="tag">&lt;/<span class="name">eulafilename</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">oem</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">oobe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">FirstExperience</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将 oobe.xml 文件复制到 C:\mount\windows\windows\system32\oobe\info\</p>
</li>
<li><p>将 oobe.xml 复制到前面创建的特定于语言的文件夹中。例如：将 oobe.xml 复制到 C:\mount\windows\Windows\System32\oobe\info\default\1033，其中包含一个名为 agreement.rtf 的英语版文件。 若要添加德语版协议，请将 oobe.xml 复制到 C:\mount\windows\Windows\System32\oobe\info\default\1031\ 目录，其中包含德语版 agreement.rtf 文件。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy E:\configset\oobe.xml c:\mount\windows\windows\system32\oobe\info\default\1033</span><br><span class="line">copy E:\configset\oobe.xml c:\mount\windows\windows\system32\oobe\info\default\1031</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，每个语言文件夹都包含该对应语言的 oobe.xml、agreement.rtf 和 agreement.thml 文件。</p>
</li>
</ol>
<p>当映像首次启动进入 OOBE 时，它将显示许可协议。</p>
<h3 id="创建一个映像信息文件并将其添加到映像"><a href="#创建一个映像信息文件并将其添加到映像" class="headerlink" title="创建一个映像信息文件并将其添加到映像"></a>创建一个映像信息文件并将其添加到映像</h3><ul>
<li><p>创建指示 Windows 映像于何时创建的 csup.txt 文件。 此文件必须包括映像创建的日期，日期格式为“年-月-日”，不得包含其他字符，且应显示在文件顶部的一行中。 此命令将创建以下文件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 4-24-2018 &gt;&quot;C:\mount\windows\Windows\csup.txt&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用应答文件自定义-Windows"><a href="#使用应答文件自定义-Windows" class="headerlink" title="使用应答文件自定义 Windows"></a>使用应答文件自定义 Windows</h2><p>应答文件（或无人参与文件）可用于在安装期间修改你的映像中的 Windows 设置。 还可以在映像中创建触发脚本的设置，在用户首次创建其帐户并选择默认语言后会运行这些脚本。 使用应答文件可以指定各种设置选项，包括磁盘分区方式、Windows 映像的安装位置和要应用的产品密钥。 还可以指定应用于 Windows 安装的值，如用户帐户的名称、显示设置以及 Internet Explorer 收藏夹。 安装程序的应答文件通常称为 Unattend.xml。</p>
<p>Unattend 文件包括多个部分，其中每个部分在整个 Windows 安装过程中的不同时间进行处理。 这些阶段称为配置阶段。 下面是最常用的阶段：</p>
<p>可以指定要在哪个配置阶段添加新设置：</p>
<ul>
<li>1 - windowsPE：这些设置由 Windows 安装程序使用。 如果你正在修改现有映像，通常可以忽略这些设置。</li>
<li>2 - offlineServicing：在使用 DISM 将 unattend 文件应用于脱机映像时处理 offlineServicing 中的设置。</li>
<li>4 - specialize：大多数设置都应在此处添加。 这些设置可同时在审核模式和 OOBE 开始时触发。 如果你需要进行多个更新或测试设置，请再次一般化设备，然后将另一批设置添加到 Specialize 配置阶段中。</li>
<li>6 - auditUser：启动审核模式后立即运行。 AuditUser 是运行系统测试脚本的适当位置。 我们将添加 Microsoft-Windows-Deployment\RunAsynchronousCommand 作为示例。 若要了解详细信息，请参阅 将自定义脚本添加到 Windows 安装程序。</li>
<li>7 - oobeSystem：请慎用。 这些设置的大多数在用户完成 OOBE 之后运行。 一个例外是 Microsoft-Windows-Deployment\Reseal\Mode &#x3D; Audit 设置，我们将使用它来绕过 OOBE 并使电脑启动进入审核模式。 如果你的脚本依赖于知道用户在 OOBE 期间选择哪种语言，请将它添加到 oobeSystem 阶段。</li>
</ul>
<p>尽管你可以在审核模式中设置很多 Windows 设置，但是某些设置只能使用应答文件或 Windows 配置设计器来设置，如添加制造商的支持信息。 有关应答文件设置（也称为无人参与设置）的完整列表，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/unattend/">无人参与的 Windows 安装程序参考</a>。</p>
<h3 id="创建应答文件"><a href="#创建应答文件" class="headerlink" title="创建应答文件"></a>创建应答文件</h3><p>使用 Windows 系统映像管理器 (SIM) 创建和修改 unattend 文件。 SIM 是作为 ADK 的一部分安装的。 我们在 USB-B 中包含了一些应答文件来帮助你入门。 确保应答设置包括 OEM 策略文档中所述的必需设置：</p>
<ul>
<li><p>对于 OA 3.0 系统：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md c:\mount\windows\windows\panther</span><br><span class="line">copy /y E:\AnswerFiles\OA3.0\Unattend.xml C:\Mount\Windows\Windows\Panther</span><br></pre></td></tr></table></figure>

<p>（其中 E: 是 USB-B）</p>
</li>
<li><p>对于非 OA 3.0 系统：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">md c:\mount\windows\Windows\panther</span><br><span class="line">copy /y E:\AnswerFiles\Non_OA3.0\Unattend.xml C:\Mount\Windows\Windows\Panther</span><br></pre></td></tr></table></figure>

<p>（其中 E: 是 USB-B）</p>
</li>
</ul>
<h4 id="在-Windows-SIM-中创建目录文件"><a href="#在-Windows-SIM-中创建目录文件" class="headerlink" title="在 Windows SIM 中创建目录文件"></a>在 Windows SIM 中创建目录文件</h4><p>目录文件 (.clg) 是包含适用于特定 Windows 映像的设置信息的文件。 在 SIM 中使用 Windows 映像时，必须首先为你正在使用的 Windows WIM 创建一个目录文件。</p>
<ol>
<li>启动 Windows 系统映像管理器 (WSIM)。</li>
<li>单击“文件”&gt;“选择 Windows 映像”。</li>
<li>在选择 Windows 映像中，浏览并选择映像文件 (D:\install.wim)。</li>
<li>选择“Windows 10 家庭版”，然后单击“确定”。</li>
<li>单击是以创建目录文件。 Windows SIM 根据映像文件创建该文件，并将其保存到映像文件所在的文件夹中。 这个过程可能需要几分钟。</li>
</ol>
<p>目录文件将显示在 Windows 映像窗格中。 Windows SIM 列出该映像中的可配置组件和程序包。</p>
<h4 id="创建应答文件-1"><a href="#创建应答文件-1" class="headerlink" title="创建应答文件"></a>创建应答文件</h4><p>如果未使用现有的 unattend 文件，可以在 Windows SIM 中创建一个新文件：</p>
<ul>
<li>单击“文件”&gt;“新建应答文件”</li>
</ul>
<p>新的应答文件将显示在右侧窗格中。</p>
<h4 id="添加应答文件设置"><a href="#添加应答文件设置" class="headerlink" title="添加应答文件设置"></a>添加应答文件设置</h4><p>本部分介绍如何创建一个可以在部署 Windows 映像时配置设置的应答文件。</p>
<p>在开始之前，请在装载的 Windows 映像中创建名为 Panther 的文件夹。 Windows 将自动在此文件夹中查找应答文件。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md c:\mount\windows\Windows\panther</span><br></pre></td></tr></table></figure>

<h5 id="添加-OEM-信息（可选）"><a href="#添加-OEM-信息（可选）" class="headerlink" title="添加 OEM 信息（可选）"></a>添加 OEM 信息（可选）</h5><ol>
<li><p>在“Windows 映像”窗格中展开“组件”，右键单击“amd64_Microsoft-Windows-Shell-Setup_(version)”，然后选择“将设置添加到阶段 4 - specialize”。</p>
</li>
<li><p>在“应答文件”窗格中，选择“Components\4specialize\amd64_Microsoft-Windows-Shell-Setup_neutral\OEMInformation”。</p>
</li>
<li><p>在“OEMInformation 属性”窗格的“设置”部分，设置：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manufacturer=Fabrikam</span><br><span class="line">Model=Notebook Model 1</span><br><span class="line">Logo=C:\Fabrikam\Fabrikam.bmp</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Panther 文件夹中将应答文件保存为 <code>USB-B\AnswerFiles\unattend.xml</code>。</p>
</li>
</ol>
<p>接下来，必须确保上面指定的徽标包含在 Windows 映像中。</p>
<ol>
<li><p>创建最大大小为 120x120 像素的 32 位彩色图像。 在技术人员电脑上，将该图像保存为 D:\AnswerFiles\Fabrikam.bmp 文件。 我们在 USB-B 上包含了以下示例图像，可将其用于本实验：D:\Logos\Fabrikam.bmp。</p>
</li>
<li><p>在装载的 Windows 映像中创建名为 <code>Fabrikam</code> 的文件夹。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir c:\mount\windows\Fabrikam</span><br></pre></td></tr></table></figure>
</li>
<li><p>将 Fabrikam.bmp 复制到刚刚创建的 Fabrikam 文件夹中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy fabrikam.bmp c:\mount\windows\fabrikam</span><br></pre></td></tr></table></figure></li>
</ol>
<h5 id="将设备设置为自动启动进入审核模式"><a href="#将设备设置为自动启动进入审核模式" class="headerlink" title="将设备设置为自动启动进入审核模式"></a>将设备设置为自动启动进入审核模式</h5><p>使用同一 unattend.xml 文件，将电脑设置为自动<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/customize/desktop/unattend/microsoft-windows-deployment-reseal-mode">启动进入审核模式</a>。</p>
<ol>
<li>在“Windows 映像”窗格中展开“组件”，右键单击“amd64_Microsoft-Windows-Deployment_(version)”，然后选择“将设置添加到阶段 7 - oobeSystem”。</li>
<li>在“应答文件”窗格中，选择“Components\7 oobeSystem\amd64_Microsoft-Windows-Deployment_neutral\Reseal”。</li>
<li>在“Reseal 属性”窗格的“设置”部分，选择 <code>Mode=Audit</code>。</li>
<li>在 Panther 文件夹中将应答文件保存为 unattend.xml。</li>
</ol>
<h5 id="启用-S-模式"><a href="#启用-S-模式" class="headerlink" title="启用 S 模式"></a>启用 S 模式</h5><p> 备注</p>
<p>如果你不想启用 S 模式，可以<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#set-the-windows-edition">跳到下一部分</a>。</p>
<p>Windows 10 版本 1803 中的新增功能：Windows 10 S 不再是独立于其他 Windows 版本的 SKU。 现在，S 模式是可以在家庭版和专业版 SKU 上激活的模式。</p>
<p>设置 S 模式 本部分介绍如何在 Windows 映像中启用 S 模式。 我们将使用包含“阶段 2 - offlineServicing”中某项设置的 unattend 文件，并使用 DISM 将其应用于装载的 Windows 映像。</p>
<ol>
<li><p>使用 Windows SIM 修改 unattend.xml。</p>
</li>
<li><p>将 amd64_Microsoft_Windows_CodeIntegrity 组件添加到“阶段 2 - offlineServicing”。</p>
</li>
<li><p>将 amd64_Microsoft_Windows_CodeIntegrity\SkuPolicyRequired 设置为 <code>1</code>。</p>
</li>
<li><p>在 Panther 文件夹中将应答文件保存为 unattend.xml。</p>
</li>
<li><p>使用 DISM 应用 unattend 文件并启用 S 模式：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:C:\mount\windows /apply-unattend:C:\mount\windows\windows\panther\unattend.xml</span><br></pre></td></tr></table></figure>

<p>注意：仅当使用 DISM 应用了 unattend 文件时，才会处理“阶段 2 - offlineServicing”。</p>
</li>
</ol>
<p>S 模式现在会应用于 Windows 映像。 当电脑启动时，将在 Windows 安装上强制实施在 Windows 10 S 中强制实施的相同代码完整性策略。</p>
<h4 id="启用制造模式"><a href="#启用制造模式" class="headerlink" title="启用制造模式"></a>启用制造模式</h4><p>如果你打算在审核模式下对映像进行其他更改（例如编辑注册表、运行脚本或从命令提示符运行命令），必须暂时启用制造模式，该模式允许一般在 S 模式下会被阻止的未签名代码在审核模式下运行。 这样，你便可以在制造过程中运行脚本、安装程序和诊断工具（即未签名代码）。 可以通过将一个注册表项添加到脱机映像来启用制造模式，在启动进入审核模式后通过删除该注册表项来禁用制造模式。</p>
<ol>
<li><p>在装载的映像上，将其中的 SYSTEM 注册表配置单元加载到技术人员电脑上的 regedit 中。 我们将使用一个名为 HKLM\Windows10S 的临时配置单元。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg load HKLM\Windows10S C:\Mount\Windows\Windows\System32\Config\System</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加 manufacturing 注册表项。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\Windows10S\ControlSet001\Control\CI\Policy /v ManufacturingMode /t REG_DWORD /d 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>从技术人员电脑中卸载注册表配置单元。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg unload HKLM\Windows10S</span><br></pre></td></tr></table></figure></li>
</ol>
<p>卸载映像并提交更改（如下所示）后，S 模式 Windows 10 映像将包含 manufacturing 注册表项，使你可以在审核模式下运行未签名代码。</p>
<p> 重要</p>
<p>在交付 S 模式 Windows 10 设备之前，请务必删除 manufacturing 注册表项。 我们稍后会在本实验中介绍如何执行此操作，你也可以在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/windows-10-s-manufacturing-mode?view=windows-10#remove-the-manufacturing-registry-key">制造模式</a>中了解相关信息</p>
<h3 id="设置-Windows-版本"><a href="#设置-Windows-版本" class="headerlink" title="设置 Windows 版本"></a>设置 Windows 版本</h3><p>在本部分，我们将 Windows OS 版本从家庭版升级到专业版。</p>
<p> 备注</p>
<ul>
<li>你无法将 Windows 映像设置为更低的版本。</li>
<li>注意：请不要对已更改为更高版本的映像使用该过程。</li>
<li>由于在参考设备上启动此映像之前不会启用 S 模式，因此是在应用无人参与设置（包括 S 模式 <code>&lt;SkuPolicyRequired&gt;</code> 元素）之前还是之后运行 &#x2F;Set-Edition 命令无关紧要。</li>
<li>一般情况下，你不会像此处所示那样脱机切换版本。 与其升级版本，不如一开始就装载一个 Windows 专业版 wim 映像。 此处包含此步骤只是为了演示 &#x2F;Set-Edition 命令的用法。</li>
</ul>
<ol>
<li><p>通过运行以下命令来确定可用版本,以确定可以将映像升级到的映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Get-TargetEditions /Image:C:\mount\windows</span><br></pre></td></tr></table></figure>

<p>请注意可用版本 ID。</p>
</li>
<li><p>将版本升级到专业版。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Set-Edition:Professional /Image:C:\mount\windows</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="通过恢复保留-Windows-设置"><a href="#通过恢复保留-Windows-设置" class="headerlink" title="通过恢复保留 Windows 设置"></a>通过恢复保留 Windows 设置</h3><p>在恢复方案中，Windows 不会自动保存通过应答文件创建的设置、使用 LayoutModification.xml 创建的 Windows“开始”菜单自定义项，或来自 oobe.xml 的首次登录信息。</p>
<p>若要确保 Windows 保存自定义项：</p>
<ul>
<li>将 unattend.xml、LayoutModification.xml 以及 C:\mount\windows\Windows\System32\OOBE 文件夹的副本保存到 C:\Recovery\OEM 中。</li>
<li>将脚本 ResetConfig.xml 和 EnableCustomizations.cmd 添加到 C:\Recovery\OEM。 从<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions-sample-scripts?preserve-view=true&view=windows-10">示例脚本：通过恢复保持 Windows 设置</a> 中获取这些脚本。</li>
</ul>
<h3 id="优化-WinRE（第-1-部分）"><a href="#优化-WinRE（第-1-部分）" class="headerlink" title="优化 WinRE（第 1 部分）"></a>优化 WinRE（第 1 部分）</h3><ol>
<li><p>增大 WinRE 映像的暂存空间大小。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /image:c:\mount\winre /set-scratchspace:512</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理未使用的文件并减小 winre.wim 的大小</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /image:&quot;c:\mount\winre&quot; /Cleanup-Image /StartComponentCleanup</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="卸载映像"><a href="#卸载映像" class="headerlink" title="卸载映像"></a>卸载映像</h3><ol>
<li><p>关闭所有可能正在访问映像中文件的应用程序，包括文件资源管理器。</p>
</li>
<li><p>提交更改并卸载 Windows RE 映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Unmount-Image /MountDir:&quot;C:\mount\winre&quot; /Commit</span><br></pre></td></tr></table></figure>

<p>其中 C 是包含该映像的驱动器的驱动器号。</p>
<p>此过程可能需要几分钟。</p>
</li>
<li><p>创建已更新的 Windows RE 映像的备份副本，并将旧的 WinRE 映像替换为新导出的映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dism /export-image /sourceimagefile:c:\mount\windows\windows\system32\recovery\winre.wim /sourceindex:1 /DestinationImageFile:c:\temp\lab\winre_bak.wim</span><br><span class="line">Del c:\mount\windows\windows\system32\recovery\winre.wim</span><br><span class="line">Copy c:\temp\lab\winre_bak.wim c:\mount\windows\windows\system32\recovery\winre.wim</span><br></pre></td></tr></table></figure>

<p>如果出现提示，请为文件指定 <code>F</code></p>
<p>故障排除：如果在指定目录下看不到 winre.wim，请使用以下命令将该文件设置为可见：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attrib -h -a -s C:\mount\windows\Windows\System32\Recovery\winre.wim</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查 Windows RE 映像的新大小：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dir &quot;C:\mount\windows\Windows\System32\Recovery\winre.wim&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据新 winre.wim 的大小调整部署脚本中的分区大小，使这些分区为 winre.wim 留出足够的空间，另外还有一些额外的可用空间。</p>
<p>按照以下分区布局大小图表确定 createpartitions-<firmware>-<imageformat>.txt 文件中恢复分区的大小。 将 winre.wim 复制到隐藏分区后所剩的可用空间量。 有关详细信息，请参阅以下磁盘分区规则。</p>
<table>
<thead>
<tr>
<th align="left">分区大小</th>
<th align="left">可用空间</th>
</tr>
</thead>
<tbody><tr>
<td align="left">小于 500 MB</td>
<td align="left">至少 50 MB 可用空间</td>
</tr>
<tr>
<td align="left">450 MB - 680 MB</td>
<td align="left">至少 320 MB 可用空间</td>
</tr>
<tr>
<td align="left">大于 680 MB</td>
<td align="left">1024 MB 可用空间</td>
</tr>
</tbody></table>
<p>createpartitions diskpart 脚本中恢复分区大小的示例：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rem == 3. Windows RE tools partition ===============</span><br><span class="line">create partition primary size=465</span><br></pre></td></tr></table></figure>
</li>
<li><p>像优化 WinRE 映像那样优化 Windows 映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Image:c:\mount\windows /Cleanup-Image /StartComponentCleanup</span><br></pre></td></tr></table></figure>
</li>
<li><p>提交更改并卸载 Windows 映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Unmount-Image /MountDir:&quot;C:\mount\windows&quot; /Commit</span><br></pre></td></tr></table></figure>

<p>其中 C 是包含该映像的驱动器的驱动器号。 此过程可能需要数分钟。</p>
</li>
<li><p>通过导出映像完成映像优化。 在导出过程中，DISM 会删除已取代的文件，并且映像中的文件大小会减小。 将 Windows 映像导出到新的映像文件中：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /Export-Image /SourceImageFile:&quot;C:\temp\lab\Images\basicimage.wim&quot; /SourceIndex:1 /DestinationImageFile:&quot;C:\temp\lab\Images\install.wim&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>现在，你已获得一个可部署到其他电脑的自定义 Windows 映像。 下一部分会介绍如何将映像部署到参考电脑、进行联机更改，然后最终确认 Windows 映像，使其为最终部署做好准备。</p>
<h2 id="将映像部署到新电脑"><a href="#将映像部署到新电脑" class="headerlink" title="将映像部署到新电脑"></a>将映像部署到新电脑</h2><p>在本部分，我们将映像部署到某台电脑，以便可以在审核模式下自定义该映像。 在开始学习本部分之前：</p>
<ul>
<li><p>将自定义映像复制到 USB-B\Images</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">copy c:\temp\lab\images\install.wim e:\images</span><br><span class="line">copy c:\temp\lab\images\winre_bak.wim e:\images</span><br></pre></td></tr></table></figure>
</li>
<li><p>确保 USB-B\Deployment 中包含部署脚本。 将 USB-B 下载内容提取到 USB-B 时，应已复制这些脚本。</p>
</li>
</ul>
<h3 id="启动进入-WinPE"><a href="#启动进入-WinPE" class="headerlink" title="启动进入 WinPE"></a>启动进入 WinPE</h3><p>如果尚未在要部署映像的设备上启动进入 WinPE，现在请启动进入 WinPE：</p>
<ol>
<li>将 USB 启动盘连接到 WinPE 分区并启动参考计算机。</li>
<li>如果使用两个不同的 USB 驱动器，请在启动 WinPE 后连接 USB-B。</li>
<li>在 X:\Windows\system32&gt; 命令行下，键入 <code>diskpart</code> 并按 Enter。</li>
<li>在 \DISKPART&gt; 命令行下，键入 <code>list volume</code>。</li>
<li>在“Label”列中，记下“Ltr”列下显示的卷标。 这是 USB 启动盘的驱动器号。 （例如 E）</li>
<li>键入 exit 退出 Diskpart</li>
</ol>
<h3 id="使用部署脚本应用映像"><a href="#使用部署脚本应用映像" class="headerlink" title="使用部署脚本应用映像"></a>使用部署脚本应用映像</h3><p>运行一个脚本来创建分区并应用映像。 我们将使用 USB-B\deployment 中的 applyimage.bat 来执行此操作。</p>
<p>ApplyImage.bat 使用 diskpart 脚本创建分区并定义分区布局。 此脚本及其调用的子脚本必须放在同一个子文件夹中。 可根据需要更新这些脚本以更改分区大小。</p>
<p> 备注</p>
<p>如果要捕获最终映像并将其部署为 FFU，请选择不配置恢复的选项。 这样，在应用 FFU 后，你可以根据需要扩展 Windows 分区。 可以在扩展 Windows 分区后再配置恢复。</p>
<ol>
<li><p>运行 applyimage.bat 并指定要应用的映像：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:</span><br><span class="line">cd Deployment</span><br><span class="line">ApplyImage.bat D:\Images\install.wim</span><br></pre></td></tr></table></figure>

<p>其中 D: 是脚本和映像所在的 USB 存储驱动器的驱动器号。</p>
<p>出现脚本提示时：</p>
<ol>
<li><p>选择是否配置恢复分区</p>
<ul>
<li><code>Y</code>：配置 Windows 恢复分区</li>
<li><code>N</code>：不配置恢复分区。 可在稍后再配置恢复分区。 如果要捕获映像并将其部署为 FFU，请选择此选项。</li>
</ul>
</li>
<li><p>按 <code>Y</code> 格式化驱动器</p>
</li>
<li><p>选择 <code>N</code>，以便不部署为精简 OS。</p>
</li>
<li><p>按 <code>N</code> 指示该映像不包含扩展属性 (EA)</p>
<p> 备注</p>
<p>请仅在基于闪存驱动器的设备上使用精简 OS，因为精简 OS 的性能严重依赖于存储设备的功能。 不建议在搭载机械硬盘的设备上使用精简 OS。 有关详细信息，请参考“精简 OS”。</p>
</li>
</ol>
</li>
<li><p>移除 USB 驱动器并重启参考电脑。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>电脑应会根据我们前面创建的 unattend 文件的设置启动进入 Windows 审核模式。 如果未使用将电脑设置为启动进入审核模式的 unattend.xml 文件，可以在 OOBE 期间按 <code>Ctrl+Shift+F3</code> 启动进入审核模式。</p>
</li>
</ol>
<h2 id="进行联机自定义（审核模式）"><a href="#进行联机自定义（审核模式）" class="headerlink" title="进行联机自定义（审核模式）"></a>进行联机自定义（审核模式）</h2><p>你可以在审核模式下使用熟悉的 Windows 环境自定义 Windows。 在审核模式下，你可以添加 Windows 桌面应用程序、更改系统设置、添加数据和运行脚本。</p>
<p>要确保你的审核模式更改包括在恢复映像中，你需要使用 ScanState 将这些更改捕获到一个预配包中。 如果出现了问题，系统恢复工具会使用此包来还原更改。 （可选）你可以直接从压缩的恢复文件运行这些应用程序来节省驱动器空间；这称为单实例存储。</p>
<p>若要捕获映像中的更改并将其应用于其他设备，需要使用 Sysprep 来通用化映像。</p>
<h3 id="在审核模式下验证自定义"><a href="#在审核模式下验证自定义" class="headerlink" title="在审核模式下验证自定义"></a>在审核模式下验证自定义</h3><p>我们不建议在制造过程中将电脑连接到 Internet，也不建议在审核模式下从 Windows 更新安装更新，因为这可能会在运行 sysprep 期间生成错误。</p>
<ol>
<li>安装程序完成后，计算机将在 Audit 模式下以管理员身份自动登录到 Windows。</li>
<li>验证应答文件中的更改（查看制造商名称、支持电话号码和其他自定义项）是否存在。</li>
</ol>
<h3 id="验证版本"><a href="#验证版本" class="headerlink" title="验证版本"></a>验证版本</h3><p>在本实验的前面部分，我们已将版本从 Windows 家庭版升级到了 Windows 专业版。 验证此项更改：</p>
<ol>
<li><p>以管理员身份打开命令提示符</p>
</li>
<li><p>运行：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism /online /get-current-edition</span><br></pre></td></tr></table></figure>
</li>
<li><p>确保该版本是正确版本。 它应如下所示：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Current edition is:</span><br><span class="line"></span><br><span class="line">Current Edition : Professional</span><br><span class="line"></span><br><span class="line">The operation completed successfully.</span><br></pre></td></tr></table></figure>

<p>注意：如果使用启用了 S 模式的设备，则版本仍会显示“Professional”。这是因为 S 模式只是一种模式，而不是版本。</p>
</li>
</ol>
<h3 id="验证-S-模式"><a href="#验证-S-模式" class="headerlink" title="验证 S 模式"></a>验证 S 模式</h3><p>如果在本实验的前面部分中启用了 S 模式，请验证是否启用了 S 模式。</p>
<ol>
<li>从“开始”菜单打开“设置”。</li>
<li>在“设置”中，打开“更新和安全”</li>
<li>在左侧窗格中选择“激活”</li>
</ol>
<p>如果为设备启用了 S 模式，则此处会显示该模式。</p>
<h3 id="应用和-Store-商机"><a href="#应用和-Store-商机" class="headerlink" title="应用和 Store 商机"></a>应用和 Store 商机</h3><p>通过 Windows 10 和 Microsoft Store，你在品牌和设备差异化、创造收益和客户接触方面可以获得巨大的商机。</p>
<p>Microsoft Store 应用是 Windows 10 体验的核心要素。 它们属于 Windows 通用应用，因此你可以为运行 Windows 10 的台式机、平板电脑或手机生成应用。 作为 OEM，你可以通过在自己制造的优质硬件上提供大量增值软件与服务，提供有吸引力的客户体验和提升品牌忠诚度。</p>
<p>重要说明：必须在审核模式下设置以下注册表项。</p>
<p>必须更改注册表设置才能添加 OEM ID。 如果你是 OEM Microsoft Store 计划参与者，请联系 <a href="mailto:&#x50;&#x61;&#x72;&#x74;&#x6e;&#101;&#x72;&#x4f;&#112;&#115;&#64;&#x6d;&#x69;&#99;&#114;&#x6f;&#115;&#x6f;&#102;&#x74;&#x2e;&#99;&#111;&#109;">&#x50;&#x61;&#x72;&#x74;&#x6e;&#101;&#x72;&#x4f;&#112;&#115;&#64;&#x6d;&#x69;&#99;&#114;&#x6f;&#115;&#x6f;&#102;&#x74;&#x2e;&#99;&#111;&#109;</a> 获取 OEM ID。</p>
<table>
<thead>
<tr>
<th align="left">项目</th>
<th align="left">注册表中的位置</th>
</tr>
</thead>
<tbody><tr>
<td align="left">OEMID</td>
<td align="left">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Store, (REG_SZ) OEMID</td>
</tr>
<tr>
<td align="left">SCM ID</td>
<td align="left">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Store, (REG_SZ) StoreContentModifier</td>
</tr>
</tbody></table>
<p>OEMID</p>
<ol>
<li>在命令提示符下运行 regedit.exe</li>
<li>导航到“HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Store”</li>
<li>在“(默认)”下右键单击 -&gt; 单击“新建”</li>
<li>单击“字符串值”</li>
<li>键入“OEMID”</li>
<li>双击“OEMID”并在“数值数据”中输入 OEM 名称：文本字段</li>
</ol>
<p>SCMID</p>
<ol>
<li>在命令提示符下运行 regedit.exe</li>
<li>导航到“HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Store”</li>
<li>在“(默认)”下右键单击 -&gt; 单击“新建”</li>
<li>单击“字符串值”</li>
<li>键入“StoreContentModifier”</li>
<li>双击“StoreContentModifier”并在“数值数据”中输入 OEM 名称：文本字段</li>
</ol>
<p> 重要</p>
<p>在 Windows 10 中，OEMID 注册表项不会在 PBR 期间自动还原。 请参阅本指南的“ScanState”部分，了解如何在执行 PBR 操作期间还原 OEMID 注册表项。</p>
<h2 id="准备映像以实现一键重置"><a href="#准备映像以实现一键重置" class="headerlink" title="准备映像以实现一键重置"></a>准备映像以实现一键重置</h2><p>本部分提供有关设置恢复环境以实现一键重置 (PBR) 方案的指导。</p>
<p>有关详细信息，请参考“一键重置”、“Windows 恢复环境 (Windows RE)”以及“硬盘驱动器和分区”。</p>
<p>一键重置是一个内置的恢复工具，使用户可以在恢复 OS 的同时保留其数据和重要自定义项，而无需提前备份数据。 该工具将向用户提供更多恢复选项，使其能够自信地修复自己的电脑，无需自定义恢复应用程序。</p>
<h3 id="准备-ScanState"><a href="#准备-ScanState" class="headerlink" title="准备 ScanState"></a>准备 ScanState</h3><p>若要开始使用一键重置，需要将 ScanState 复制到 USB-B。</p>
<p>使用 ScanState 捕获映像中的经典 Windows 应用程序和设置。</p>
<p>注意：你将使用技术人员电脑来准备 ScanState。</p>
<ol>
<li><p>在技术人员电脑上插入 USB-B</p>
</li>
<li><p>以管理员身份打开部署和映像工具命令提示符</p>
</li>
<li><p>运行 copydandi.cmd，将所需的文件复制到 USB-B\scanstate：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copydandi.cmd amd64 e:\scanstate</span><br></pre></td></tr></table></figure>

<p>其中 E: 是 USB-B 的驱动器号。</p>
</li>
</ol>
<h3 id="创建-ScanState-迁移文件"><a href="#创建-ScanState-迁移文件" class="headerlink" title="创建 ScanState 迁移文件"></a>创建 ScanState 迁移文件</h3><p>在本部分，你将创建一个配置文件，用于在一键重置期间还原文件和注册表项。</p>
<p>创建用于还原在制造过程中手动输入的注册表值的迁移 XML 文件。 下面的示例将还原之前在本文档中设置的 OEMID 注册表值。</p>
<p>注意：USB-B\recovery\recoveryimage\regrecover.xml 已包含注册表值。 可以使用此文件，而无需创建新文件。</p>
<ol>
<li><p>打开记事本</p>
</li>
<li><p>将以下 xml 复制并粘贴到记事本中。 此代码告知 ScanState 迁移 OEMID 注册表项：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">migration</span> <span class="attr">urlid</span>=<span class="string">&quot;https://www.microsoft.com/migration/1.0/migxmlext/test&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">component</span> <span class="attr">type</span>=<span class="string">&quot;System&quot;</span> <span class="attr">context</span>=<span class="string">&quot;UserAndSystem&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>OEMID<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">role</span> <span class="attr">role</span>=<span class="string">&quot;Settings&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">rules</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">include</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">objectSet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">pattern</span> <span class="attr">type</span>=<span class="string">&quot;Registry&quot;</span>&gt;</span>HKLM\Software\Microsoft\Windows\CurrentVersion\Store [OEMID]<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">objectSet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">role</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">migration</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果启用了 S 模式，请告知 ScanState 排除 manufacturing 注册表项，确保不会迁移该项。 添加以下规则以排除该注册表项：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">unconditionalExclude</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">objectSet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span> <span class="attr">type</span>=<span class="string">&quot;Registry&quot;</span>&gt;</span>HKLM\SYSTEM\CurrentControlSet\Control\CI\Policy [ManufacturingMode]<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">objectSet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">unconditionalExclude</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将文件保存为 regerecover.xml。</p>
</li>
</ol>
<h3 id="使用-ScanState-创建恢复包"><a href="#使用-ScanState-创建恢复包" class="headerlink" title="使用 ScanState 创建恢复包"></a>使用 ScanState 创建恢复包</h3><p>在参考电脑上：</p>
<p>使用 ScanState 将已安装的自定义项捕获到预配程序包中，然后将其保存到 C:\Recovery\customizations。 我们将使用 USB-B\Recovery\RecoveryImage 中的示例来创建预配程序包。</p>
<p>重要说明：要使一键重置正常运行，包必须是存储在 C:\Recovery\Customizations 中的 .ppkg 文件。</p>
<ol>
<li><p>创建恢复 OEM 文件夹并复制 USB-B\Recovery\RecoveryImage 的内容</p>
<p>重要说明：若要在恢复期间保留自定义的“开始”布局菜单，在恢复期间需要再次复制 layoutmodification.xml。 我们将其复制到此处，然后在恢复期间使用 EnableCustomizations.cmd 进行复制。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Copy E:\Recovery\RecoveryImage c:\recovery\OEM</span><br><span class="line">Copy E:\StartLayout\layoutmodification.xml c:\recovery\OEM</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行 ScanState，收集应用和自定义项</p>
<p>对于 x64 Windows 10 电脑：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir c:\recovery\customizations</span><br><span class="line">E:\ScanState\scanstate.exe /apps /ppkg C:\Recovery\Customizations\apps.ppkg /i:c:\recovery\oem\regrecover.xml /config:E:\scanstate\Config_AppsAndSettings.xml /o /c /v:13 /l:C:\ScanState.log</span><br></pre></td></tr></table></figure>

<p>其中 E: 是 USB-B 的驱动器号</p>
</li>
<li><p>ScanState 成功完成后，删除 scanstate.log 和 miglog.xml 文件：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">del c:\scanstate.log</span><br><span class="line">del c:\miglog.xml</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="创建扩展性脚本以还原其他设置"><a href="#创建扩展性脚本以还原其他设置" class="headerlink" title="创建扩展性脚本以还原其他设置"></a>创建扩展性脚本以还原其他设置</h3><p>你可以通过配置可扩展性点自定义一键重置体验。 这允许你运行自定义脚本、安装其他应用程序，或者保留其他用户、应用程序或注册表数据。</p>
<p>在恢复期间，PBR 将调用我们要配置的 EnableCustomizations.cmd，该命令执行两项操作：</p>
<ol>
<li>将用于初始部署的 unattend.xml 文件复制到 \windows\panther。</li>
<li>将 layoutmodification.xml 复制到系统。</li>
</ol>
<p>此文件将在 PBR 期间从这两个应答文件还原其他布局设置。</p>
<blockquote>
<p>[!重要信息：必须将恢复脚本和 unattend.xml 复制到 C:\Recovery\OEM，以便 PBR 拾取并还原 unattend.xml 中定义的设置。</p>
</blockquote>
<h3 id="复制用于还原设置的-unattend-xml-文件"><a href="#复制用于还原设置的-unattend-xml-文件" class="headerlink" title="复制用于还原设置的 unattend.xml 文件"></a>复制用于还原设置的 unattend.xml 文件</h3><p>对于 OA 3.0 系统：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy e:\AnswerFiles\oa3.0\unattendsysprep.xml c:\Recovery\OEM\unattend.xml</span><br></pre></td></tr></table></figure>

<p>对于非 OA 3.0 系统：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy e:\AnswerFiles\non_oa3.0\unattendsysprep.xml c:\Recovery\OEM\unattend.xml</span><br></pre></td></tr></table></figure>

<h3 id="复制-winre-wim-备份"><a href="#复制-winre-wim-备份" class="headerlink" title="复制 winre.wim 备份"></a>复制 winre.wim 备份</h3><p>在部署期间会移动 winre.wim 文件。 在捕获最终映像之前，必须将我们创建的备份 winre.wim 复制回来，否则恢复环境无法在最终映像部署中正常工作。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Copy e:\images\winre_bak.wim c:\windows\system32\recovery\winre.wim</span><br></pre></td></tr></table></figure>

<h3 id="重新密封映像"><a href="#重新密封映像" class="headerlink" title="重新密封映像"></a>重新密封映像</h3><p>在本部分，我们将使用 sysprep.exe 重新密封映像，并为工厂部署做好准备。</p>
<ol>
<li>删除已经为预加载的应用程序创建的安装文件夹和文件。 这些文件夹可能会增大捕获的 .wim 文件的大小。</li>
<li>如果 SysPrep 工具已打开，请将其关闭并以管理员模式打开命令提示符。</li>
<li>使用包含附加设置的应答文件来通用化映像：</li>
</ol>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\Sysprep\sysprep /oobe /generalize /unattend:c:\recovery\oem\Unattend.xml /shutdown</span><br></pre></td></tr></table></figure>

<h3 id="删除-S-模式-Windows-10-的-manufacturing-注册表项"><a href="#删除-S-模式-Windows-10-的-manufacturing-注册表项" class="headerlink" title="删除 S 模式 Windows 10 的 manufacturing 注册表项"></a>删除 S 模式 Windows 10 的 manufacturing 注册表项</h3><p>如果启用了制造模式，请删除 manufacturing 注册表项：</p>
<ol>
<li><p>打开命令提示符。</p>
</li>
<li><p>删除该注册表项：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg delete HKLM\system\ControlSet001\Control\CI\Policy /v ManufacturingMode</span><br></pre></td></tr></table></figure>

<p> 重要</p>
<p>请不要交付使用了该注册表项的 S 模式 Windows 10 设备。</p>
</li>
</ol>
<h2 id="最终确认并捕获映像"><a href="#最终确认并捕获映像" class="headerlink" title="最终确认并捕获映像"></a>最终确认并捕获映像</h2><p>下面介绍如何最终确认并捕获工厂映像，以进行大规模部署。 若要开始学习本部分，请确保在上一部分中运行 sysprep 后已关闭参考计算机。</p>
<ol>
<li>将参考计算机引导进入 WinPE。</li>
<li>启动 WinPE 后，连接 USB-B。</li>
</ol>
<h3 id="疑难解答"><a href="#疑难解答" class="headerlink" title="疑难解答"></a>疑难解答</h3><ul>
<li><p>如果参考电脑从其内部 HDD 启动，则 Windows 将进入专用化和 OOBE 了阶段。 如果任一配置阶段已完成，你将无法捕获稳定的通用化映像。 如果其中任一阶段已完成，你需要再次通用化映像。 可以在审核模式下执行该操作（在 OOBE 期间按 Ctrl+Shift+F3）&lt;&gt;&lt;&gt;&lt;&gt;。 在审核模式下，运行上述 Sysprep 命令。 确保电脑在下次重启时启动进入 WinPE。</p>
</li>
<li><p>如果系统仍然启动进入内部 HDD，请检查电脑的启动优先级。 确保 USB 的启动优先级高于内部硬盘驱动器。</p>
</li>
<li><p>使用 diskpart 标识 Windows 分区驱动器号。</p>
<ol>
<li>在 X：\windows\system32&gt; 提示符下，键入 diskpart，然后按 <strong>Enter</strong> 键启动 Diskpart。</li>
<li>在 \DISKPART&gt; 提示符下键入 <code>list volume</code>。</li>
<li>在“Label”列下，找到标有“Windows”的卷。</li>
<li>记下“Ltr”列下的、分配给该卷的驱动器号（例如 C）。 这是 USB 启动盘的驱动器号。</li>
</ol>
<p>cmd复制</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">WINDOWS</span>\<span class="title">system32</span>&gt;<span class="title">diskpart</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">DiskPart</span> <span class="title">version</span> 10.0.19628.1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">On</span> <span class="title">computer</span>: <span class="title">Windows</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">DISKPART</span>&gt; <span class="title">list</span> <span class="title">volume</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Volume</span> ###  <span class="title">Ltr</span>  <span class="title">Label</span>        <span class="title">Fs</span>     <span class="title">Type</span>        <span class="title">Size</span>     <span class="title">Status</span>     <span class="title">Info</span></span></span><br><span class="line"><span class="function">----------  ---  -----------  -----  ----------  -------  ---------  --------</span></span><br><span class="line"><span class="function"><span class="title">Volume</span> 0         <span class="title">System</span>       <span class="title">NTFS</span>   <span class="title">Partition</span>    100 <span class="title">MB</span>  <span class="title">Healthy</span>    <span class="title">System</span></span></span><br><span class="line"><span class="function"><span class="title">Volume</span> 1     <span class="title">C</span>   <span class="title">Windows</span>      <span class="title">NTFS</span>   <span class="title">Partition</span>    465 <span class="title">GB</span>  <span class="title">Healthy</span>    <span class="title">Boot</span></span></span><br><span class="line"><span class="function"><span class="title">Volume</span> 2         <span class="title">Recovery</span>     <span class="title">NTFS</span>   <span class="title">Partition</span>    500 <span class="title">MB</span>  <span class="title">Healthy</span>    <span class="title">Hidden</span></span></span><br><span class="line"><span class="function"><span class="title">Volume</span> 3     <span class="title">D</span>                       <span class="title">Removable</span>         <span class="title">B</span>  <span class="title">No</span> <span class="title">Media</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">5. <span class="title">Type</span> <span class="title">exit</span> <span class="title">to</span> <span class="title">quit</span> <span class="title">Diskpart</span>.</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="（仅限-CompactOS）转换已安装的自定义项"><a href="#（仅限-CompactOS）转换已安装的自定义项" class="headerlink" title="（仅限 CompactOS）转换已安装的自定义项"></a>（仅限 CompactOS）转换已安装的自定义项</h3><p>本部分介绍如何减小 ScanState 包的大小。</p>
<p> 重要</p>
<p>仅当你要部署到存储有限的设备时才需要执行此步骤。 单实例将影响某些桌面应用程序的启动性能。</p>
<p>有关详细信息，请参阅<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/compact-os?view=windows-10">精简 OS</a>。</p>
<p>若要减小 ScanState 恢复包的大小，请在参考设备上的 WinPE 中运行以下命令：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM /Apply-CustomDataImage /CustomDataImage:C:\Recovery\Customizations\apps.ppkg /ImagePath:C:\ /SingleInstance</span><br></pre></td></tr></table></figure>

<h2 id="捕获映像"><a href="#捕获映像" class="headerlink" title="捕获映像"></a>捕获映像</h2><p>本部分介绍如何捕获 sysprep 映像。 可以捕获 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#capture-a-wim">WIM</a> 或 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#capture-an-ffu">FFU</a>。</p>
<h3 id="捕获-WIM"><a href="#捕获-WIM" class="headerlink" title="捕获 WIM"></a>捕获 WIM</h3><p>在参考电脑上：</p>
<ol>
<li><p>标识 Windows 分区驱动器号。</p>
<ol>
<li>在 X：\windows\system32&gt; 提示符下，键入 diskpart，然后按 <strong>Enter</strong> 键启动 Diskpart。</li>
<li>在 \DISKPART&gt; 提示符下，键入“list volume”</li>
<li>在“Label”列下，找到标有“Windows”的卷</li>
<li>记下“Ltr”列下的、分配给该卷的驱动器号（例如 C）。 这是需要使用的驱动器号</li>
<li>键入 exit 退出 Diskpart</li>
</ol>
</li>
<li><p>将 Windows 分区的映像捕获到 USB-B。 此过程需要几分钟。</p>
<p>注意：建议在运行 DISM 时使用缓存目录。 在此步骤中，我们将在 USB-B 启动盘上创建 scratchdir 用于保存临时文件，但你可以选择在任何具有可用空间的硬盘驱动器上创建暂存目录。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MD e:\scratchdir</span><br><span class="line">Dism /Capture-Image /CaptureDir:C:\ /ImageFile:E:\Images\CustomImage.wim /Name:&quot;CustomImage&quot; /scratchdir:e:\scratchdir</span><br></pre></td></tr></table></figure>

<p>这会将名为 CustomImage.wim 的映像捕获到 <code>E:\Images</code>。 映像捕获完成后，可以关闭参考电脑。</p>
</li>
</ol>
<p>捕获映像后，可以转到<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10#verify-your-final-image">验证最终映像</a>。</p>
<h3 id="捕获-FFU"><a href="#捕获-FFU" class="headerlink" title="捕获 FFU"></a>捕获 FFU</h3><p>在参考电脑上：</p>
<ol>
<li><p>标识 Windows 分区驱动器号。</p>
<ol>
<li>在 X：\windows\system32&gt; 提示符下，键入 diskpart，然后按 <strong>Enter</strong> 键启动 Diskpart。</li>
<li>在 \DISKPART&gt; 提示符下，键入“list disk”</li>
<li>在“Disk ###”列下，找到包含 Windows 安装的磁盘，并记下分配的磁盘编号。 此编号类似于“Disk 0”。</li>
<li>键入 exit 退出 Diskpart</li>
</ol>
</li>
<li><p>将 Windows 磁盘的映像捕获到 USB-B。 此过程需要几分钟。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DISM.exe /capture-ffu /imagefile=E:\Images\CustomImage.wim /Name:&quot;CustomImage&quot; /capturedrive=\\.\PhysicalDrive0 /description:&quot;Windows 10 FFU&quot;</span><br></pre></td></tr></table></figure>

<p>这会将名为 CustomImage.wim 的映像捕获到 <code>E:\Images</code>。 映像捕获完成后，可以关闭参考电脑。</p>
</li>
</ol>
<h2 id="验证最终映像"><a href="#验证最终映像" class="headerlink" title="验证最终映像"></a>验证最终映像</h2><p>本部分介绍如何部署捕获的映像，以进行测试和验证。</p>
<h3 id="将映像部署到参考设备"><a href="#将映像部署到参考设备" class="headerlink" title="将映像部署到参考设备"></a>将映像部署到参考设备</h3><ol>
<li><p>将要在其上测试映像的电脑启动进入 WinPE。</p>
</li>
<li><p>运行 applyimage.bat 以部署映像。</p>
<p>如果捕获了名为 customimage.wim 的 WIM：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\Deployment\applyimage.bat E:\Images\customimage.wim</span><br></pre></td></tr></table></figure>

<p><strong>or</strong></p>
<p>如果捕获了名为 CustomImage.FFU 的 FFU：</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\Deployment\applyimage.bat E:\Images\CustomImage.FFU</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照脚本的提示应用该映像。</p>
</li>
<li><p>键入 <code>exit</code> 关闭 WinPE 并重启电脑。</p>
</li>
</ol>
<h3 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h3><p>电脑将重启并首次启动进入 Windows。</p>
<ol>
<li><p>在 OOBE 中，创建一个稍后将被删除的虚构用户。</p>
</li>
<li><p>验证所有应用程序和脱机自定义项是否仍在映像中并在正常工作。</p>
<p>需要检查的一些项：</p>
<ul>
<li>任务栏</li>
<li>已固定应用</li>
<li>桌面壁纸设置为显示正确的图像</li>
<li>OEM 信息正确显示</li>
<li>OEM 应用 ID 注册表项已设置</li>
<li>默认主题是你选择的主题</li>
<li>Store 应用正常启动</li>
<li>桌面应用程序正常启动</li>
<li>通过 SPP 应用的桌面应用程序可正常启动</li>
<li>如果启用了 S 模式，请确保已删除 manufacturing 注册表项</li>
</ul>
</li>
</ol>
<h3 id="验证恢复"><a href="#验证恢复" class="headerlink" title="验证恢复"></a>验证恢复</h3><ol>
<li>从以下入口点运行“保留我的文件”和“删除所有内容”功能，验证自定义项在恢复后是否已还原并可继续正常运行：<ul>
<li>设置 a. 在“开始”菜单单击“设置”，b. 在“设置”应用中，依次单击“更新和安全”、“恢复”。 c. 单击“重置此电脑”下的“开始”按钮，然后按照屏幕上的说明进行操作。</li>
<li>Windows RE a. 在 Windows RE 的“选择一个选项”屏幕中，单击“故障排除”b. 单击“重置此电脑”，然后按照屏幕上的说明进行操作</li>
</ul>
</li>
<li>验证是否可以创建恢复媒体，并通过运行裸机恢复功能来验证其功能：a. 在控制面板中启动“创建恢复驱动器”。b. 按照屏幕上的说明创建 USB 恢复驱动器。c. 从 USB 恢复驱动器启动电脑。d. 在“选择一个选项”屏幕中，单击“故障排除”。e. 单击“从驱动器恢复”，然后按照屏幕上的说明进行操作</li>
</ol>
<p>注意：Windows 10 中的一键重置 UI 已经过重新设计。 UI 中“保留我的文件”选项现在对应于“保留我的文件”功能。 “删除所有内容”对应于“删除所有内容”功能。</p>
<h2 id="优化最终映像"><a href="#优化最终映像" class="headerlink" title="优化最终映像"></a>优化最终映像</h2><p>现在，你已获得一个几乎已做好部署准备的 Windows 映像。 本部分介绍如何对映像进行最后的微调，以便为部署做好准备。</p>
<ul>
<li><p>通过导出映像的副本，从映像中删除未使用的包。</p>
<p>command复制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dism /export-image /sourceimagefile:E:\images\customimage.wim /sourceindex:1 /destinationimagefile:e:\images\MasterImage_Pro.wim</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="最终交付"><a href="#最终交付" class="headerlink" title="最终交付"></a>最终交付</h2><p>在交付电脑之前，必须至少启动电脑一次，以完成 Windows 安装程序的专用化配置阶段。</p>
<p>特殊化配置阶段向电脑添加特定硬件信息，并在 Windows OOBE 出现的时候完成。</p>
<p>有关更多详细信息，请参阅 OEM 策略文档。</p>
<h3 id="减少磁盘占用量"><a href="#减少磁盘占用量" class="headerlink" title="减少磁盘占用量"></a>减少磁盘占用量</h3><p>整篇指南已介绍了减少磁盘占用量的多种方式：</p>
<ul>
<li>使用 Dism &#x2F;export-image</li>
<li>使用精简 OS</li>
<li>结合使用精简 OS 和单实例</li>
</ul>
<p>本部分介绍可以获得更多可用空间的其他几种方法。</p>
<h4 id="缩小和关闭-Hiberfile"><a href="#缩小和关闭-Hiberfile" class="headerlink" title="缩小和关闭 Hiberfile"></a>缩小和关闭 Hiberfile</h4><p>缩小和关闭 hiberfile 可以在部署的 OS 上恢复 400MB 到 1.5GB 的 OS 空间。</p>
<h4 id="将-Hiberfile-缩小-30"><a href="#将-Hiberfile-缩小-30" class="headerlink" title="将 Hiberfile 缩小 30%"></a>将 Hiberfile 缩小 30%</h4><p>结合 unattend.xml 运行 sysprep.exe 时，可以添加一个 FirstLogonCommand 来缩小 hiberfile：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">unattend</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:unattend&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span> <span class="attr">pass</span>=<span class="string">&quot;oobeSystem&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;Microsoft-Windows-Shell-Setup&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FirstLogonCommands</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SynchronousCommand</span> <span class="attr">wcm:action</span>=<span class="string">&quot;add&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">CommandLine</span>&gt;</span>powercfg /h /type reduced<span class="tag">&lt;/<span class="name">CommandLine</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Description</span>&gt;</span>Reduce hiberfile size<span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Order</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Order</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">RequiresUserInput</span>&gt;</span>false<span class="tag">&lt;/<span class="name">RequiresUserInput</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">SynchronousCommand</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">FirstLogonCommands</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">unattend</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="关闭-Hiberfile"><a href="#关闭-Hiberfile" class="headerlink" title="关闭 Hiberfile"></a>关闭 Hiberfile</h4><p>结合 unattend.xml 运行 sysprep.exe 时，可以添加一个 FirstLogonCommand 来关闭 hiberfile：</p>
<p>XML复制</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">unattend</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:unattend&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span> <span class="attr">pass</span>=<span class="string">&quot;oobeSystem&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;Microsoft-Windows-Shell-Setup&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FirstLogonCommands</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SynchronousCommand</span> <span class="attr">wcm:action</span>=<span class="string">&quot;add&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">CommandLine</span>&gt;</span>powercfg /h /type Off<span class="tag">&lt;/<span class="name">CommandLine</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Description</span>&gt;</span>Reduce hiberfile size<span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Order</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Order</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">RequiresUserInput</span>&gt;</span>false<span class="tag">&lt;/<span class="name">RequiresUserInput</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">SynchronousCommand</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">FirstLogonCommands</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">unattend</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用包含这些设置的 unattend.xml 文件捕获映像。</p>
<h3 id="经过优化的磁盘占用量"><a href="#经过优化的磁盘占用量" class="headerlink" title="经过优化的磁盘占用量"></a>经过优化的磁盘占用量</h3><p>下表显示了在 2GB (x86) 和 4GB (x64) 电脑上使用精简 OS、单实例化以及缩小或关闭 Hiberfile 的情况下可节省的额外空间。</p>
<table>
<thead>
<tr>
<th align="left">空间占用类型</th>
<th align="left">Windows 10 家庭版 x86，2GB 内存</th>
<th align="left">Windows 10 家庭版 x64，4GB 内存</th>
</tr>
</thead>
<tbody><tr>
<td align="left">基本占用空间</td>
<td align="left">11.68GB（额外空间）</td>
<td align="left">15.06GB（额外空间）</td>
</tr>
<tr>
<td align="left">精简 OS，不使用单实例</td>
<td align="left">8.85GB (&gt;2.75GB)</td>
<td align="left">11.3GB (&gt;3.7GB)</td>
</tr>
<tr>
<td align="left">精简 OS，使用单实例</td>
<td align="left">7.66GB (&gt;4GB)</td>
<td align="left">10.09GB (&gt;4.75GB)</td>
</tr>
<tr>
<td align="left">关闭 Hiberfile，不使用精简 OS</td>
<td align="left">10.87GB (&gt;825MB)</td>
<td align="left">13.48GB (&gt;1.5GB)</td>
</tr>
<tr>
<td align="left">缩小 Hiberfile，不使用精简 OS</td>
<td align="left">11.27GB (&gt;400MB)</td>
<td align="left">14.15GB (&gt;930MB)</td>
</tr>
</tbody></table>
<p>##文章来自于<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-hardware/manufacture/desktop/oem-deployment-of-windows-desktop-editions?view=windows-10">微软</a></p>

      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="">
              Windows操作系统
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>南辞</a>
    </li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/2022/06/08/Windows/Windows 10 桌面版的 OEM 部署/" target="_blank" title="Windows 10 桌面版的 OEM 部署">https://nancimua.github.io/2022/06/08/Windows/Windows 10 桌面版的 OEM 部署/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网站所有文章除特别声明外,均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      许可协议。转载请注明出处!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://pic1.zhimg.com/80/v2-22ca6e40bd3d76b7f0ebac9d1de35b0e_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pic1.zhimg.com/80/v2-22ca6e40bd3d76b7f0ebac9d1de35b0e_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
    </div>
    <a href="/2022/06/08/HTML5+CSS3.0/HTML5%20%E7%AC%94%E8%AE%B0/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> 上一篇:
        <div class="title-text">HTML5 笔记</div>
      </div>
      
      <!-- <div class="content">
        Visual Studio Code插件推荐
Live Server : 实时更新修改后的网页
TabNine : 更好
      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://pica.zhimg.com/80/v2-32b46d731bad646bd3f8d6a21e364a13_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pica.zhimg.com/80/v2-32b46d731bad646bd3f8d6a21e364a13_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" src="" alt="">
    </div>
    <a href="/2022/06/08/Windows/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%AE%89%E8%A3%85Windows/" class="post-nav-link">
      <div class="title">
        下一篇: <i class="fas fa-angle-right"></i>
        <div class="title-text">命令行安装Windows</div>
      </div>
      <!-- <div class="content">
        12345678910111213141516171819202122232425262728Diskpart     
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    

    <!-- 分享 -->
    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>

<!-- comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <aside id='l_side'>
  
    
      <section class="widget side_blogger">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/aboutme/'>
          <img src='https://picx.zhimg.com/80/v2-c7fcadd83875ab40da79d66fce108981_1440w.png'/>
        </a>
      
    
    
      <div class='text'>
        
          <h2>南辞</h2>
        
        
        
          <p><span id="jinrishici-sentence">南辞的家</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="https://space.bilibili.com/689915465"
              class="social fa-brands fa-bilibili flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="mailto:1362593067@qq.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="https://github.com/nancimua/nanci.github.io"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1362593067"
              class="social fab fa-qq flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
      </div>
    
  </div>
</section>

    
  
  
  
    
      <div class="widget moyu" id="moyu" style="order: 0;background: #e9e5d1">
        <header>
          
            <a style="color: #d63130" target="_blank" rel="noopener" href='http://baidu.com'><i class="fa-solid fa-fish fa-fw" aria-hidden="true"></i><span class='name'>开始摸鱼</span></a>
          
        </header>
        <div class="content">
          <img class="no-lazy" src="https://api.vvhan.com/api/moyu" style="width:100%">
        </div>
    </div>
    
  

  <div class="layout_sticky">    
    
      
<section class="widget side_toc">
  
  <header>
    
      <i style="color: " class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name' style="color: ">本文目录</span>
    
  </header>


  <div class='content'>
    <div class="toc-main">
      <div class="toc-content">
        <!-- <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%8E%AF%E5%A2%83"><span class="toc-text">准备实验室环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%80%82%E7%94%A8%E4%BA%8E-Windodws-10-%E7%9A%84-Windows-ADK"><span class="toc-text">安装适用于 Windodws 10 的 Windows ADK</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%AF%E5%90%AF%E5%8A%A8%E7%9A%84-Windows-PE-WinPE-%E5%88%86%E5%8C%BA"><span class="toc-text">创建可启动的 Windows PE (WinPE) 分区</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-WinPE-%E6%96%87%E4%BB%B6"><span class="toc-text">准备 WinPE 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-WinPE"><span class="toc-text">自定义 WinPE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD-WinPE-%E6%98%A0%E5%83%8F"><span class="toc-text">装载 WinPE 映像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E5%8C%85%E3%80%81%E5%8F%AF%E9%80%89%E7%BB%84%E4%BB%B6%E3%80%81%E4%BE%9D%E8%B5%96%E9%A1%B9%E5%92%8C%E8%AF%AD%E8%A8%80%E5%8C%85%E6%B7%BB%E5%8A%A0%E5%88%B0-WinPE%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">将包、可选组件、依赖项和语言包添加到 WinPE（可选）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E6%B7%BB%E5%8A%A0%E5%88%B0-WinPE%EF%BC%88%E5%A6%82%E6%9E%9C%E9%9C%80%E8%A6%81%EF%BC%89"><span class="toc-text">将驱动程序添加到 WinPE（如果需要）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E7%94%B5%E6%BA%90%E6%96%B9%E6%A1%88%E8%AE%BE%E7%BD%AE%E4%B8%BA%E9%AB%98%E6%80%A7%E8%83%BD"><span class="toc-text">将电源方案设置为高性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%85%E7%90%86-WinPE-%E6%98%A0%E5%83%8F"><span class="toc-text">清理 WinPE 映像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E6%9B%B4%E6%94%B9%E5%B9%B6%E5%8D%B8%E8%BD%BD%E6%98%A0%E5%83%8F"><span class="toc-text">提交更改并卸载映像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%AF%E5%90%AF%E5%8A%A8%E7%9A%84-WinPE-%E9%A9%B1%E5%8A%A8%E5%99%A8"><span class="toc-text">创建可启动的 WinPE 驱动器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E5%8F%82%E8%80%83%E7%94%B5%E8%84%91%E5%90%AF%E5%8A%A8%E8%BF%9B%E5%85%A5-WinPE"><span class="toc-text">将参考电脑启动进入 WinPE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89-Windows-%E6%98%A0%E5%83%8F"><span class="toc-text">自定义 Windows 映像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%92%8C%E8%A3%85%E8%BD%BD-Windows-%E6%98%A0%E5%83%8F"><span class="toc-text">准备和装载 Windows 映像</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD-Windows-%E6%98%A0%E5%83%8F%E6%96%87%E4%BB%B6"><span class="toc-text">备份 Windows 映像文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD-Windows-%E6%98%A0%E5%83%8F"><span class="toc-text">装载 Windows 映像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A3%85%E8%BD%BD-WinRE-%E6%98%A0%E5%83%8F"><span class="toc-text">装载 WinRE 映像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%B1%E6%9C%BA%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-text">脱机自定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E8%AF%AD%E8%A8%80"><span class="toc-text">关于语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%88%96%E6%9B%B4%E6%94%B9%E8%AF%AD%E8%A8%80"><span class="toc-text">添加或更改语言</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E8%AF%AD%E8%A8%80%E6%96%87%E4%BB%B6"><span class="toc-text">复制语言文件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%AD%E8%A8%80%E8%AE%BE%E7%BD%AE"><span class="toc-text">配置语言设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%BB%98%E8%AE%A4%E6%97%B6%E5%8C%BA"><span class="toc-text">设置默认时区</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E6%98%A0%E5%83%8F%E4%B8%AD%E5%88%A0%E9%99%A4%E5%9F%BA%E7%A1%80%E8%AF%AD%E8%A8%80"><span class="toc-text">从映像中删除基础语言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E8%AF%AD%E8%A8%80%E6%B7%BB%E5%8A%A0%E5%88%B0-Windows-RE"><span class="toc-text">将语言添加到 Windows RE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E-WinRE-%E4%B8%AD%E5%88%A0%E9%99%A4%E5%9F%BA%E7%A1%80%E8%AF%AD%E8%A8%80%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">从 WinRE 中删除基础语言（可选）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F"><span class="toc-text">驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E6%B7%BB%E5%8A%A0%E5%88%B0-Windows-%E6%98%A0%E5%83%8F"><span class="toc-text">将驱动程序添加到 Windows 映像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E9%A9%B1%E5%8A%A8%E7%A8%8B%E5%BA%8F%E6%B7%BB%E5%8A%A0%E5%88%B0-WinRE-%E6%98%A0%E5%83%8F"><span class="toc-text">将驱动程序添加到 WinRE 映像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0"><span class="toc-text">更新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-Windows-%E6%9B%B4%E6%96%B0%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%98%A0%E5%83%8F"><span class="toc-text">将 Windows 更新添加到映像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%9B%B4%E6%96%B0%E5%8C%85%E6%B7%BB%E5%8A%A0%E5%88%B0-WinRE"><span class="toc-text">将更新包添加到 WinRE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD%E5%92%8C%E5%BA%94%E7%94%A8"><span class="toc-text">功能和应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E9%9C%80%E5%8A%9F%E8%83%BD"><span class="toc-text">按需功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E5%BA%94%E7%94%A8%E2%80%9D"><span class="toc-text">“应用”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85%E5%86%85%E7%BD%AE%E5%BA%94%E7%94%A8"><span class="toc-text">重新安装内置应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-Microsoft-Store-%E5%BA%94%E7%94%A8"><span class="toc-text">添加 Microsoft Store 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8D%E4%BC%9A%E5%9B%BA%E5%AE%9A%E5%88%B0%E2%80%9C%E5%BC%80%E5%A7%8B%E2%80%9D%E8%8F%9C%E5%8D%95%E7%9A%84-Microsoft-Store-%E5%BA%94%E7%94%A8"><span class="toc-text">安装不会固定到“开始”菜单的 Microsoft Store 应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%B7%B2%E5%AE%89%E8%A3%85%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">优化已安装的应用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E8%A3%85-Microsoft-Office"><span class="toc-text">预装 Microsoft Office</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E9%9B%86"><span class="toc-text">相关集</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%86-Office-%E5%BA%94%E7%94%A8%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%98%A0%E5%83%8F"><span class="toc-text">将 Office 应用添加到映像</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E2%80%9C%E5%BC%80%E5%A7%8B%E2%80%9D%E8%8F%9C%E5%8D%95%E5%B8%83%E5%B1%80"><span class="toc-text">修改“开始”菜单布局</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Windows-10-%E7%89%88%E6%9C%AC-1803-%E4%B8%AD%E7%9A%84%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">Windows 10 版本 1803 中的新增功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%80%9C%E5%BC%80%E5%A7%8B%E2%80%9D%E8%8F%9C%E5%8D%95"><span class="toc-text">“开始”菜单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E2%80%9C%E5%BC%80%E5%A7%8B%E2%80%9D%E8%8F%9C%E5%8D%95%E5%B8%83%E5%B1%80"><span class="toc-text">关于“开始”菜单布局</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E8%AE%B8%E5%8F%AF%E5%8D%8F%E8%AE%AE%E5%92%8C%E4%BF%A1%E6%81%AF%E6%96%87%E4%BB%B6"><span class="toc-text">添加许可协议和信息文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%89%B9%E5%AE%9A%E4%BA%8E-OEM-%E7%9A%84%E8%AE%B8%E5%8F%AF%E8%AF%81"><span class="toc-text">添加特定于 OEM 的许可证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%98%A0%E5%83%8F%E4%BF%A1%E6%81%AF%E6%96%87%E4%BB%B6%E5%B9%B6%E5%B0%86%E5%85%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%98%A0%E5%83%8F"><span class="toc-text">创建一个映像信息文件并将其添加到映像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6%E8%87%AA%E5%AE%9A%E4%B9%89-Windows"><span class="toc-text">使用应答文件自定义 Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6"><span class="toc-text">创建应答文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8-Windows-SIM-%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6"><span class="toc-text">在 Windows SIM 中创建目录文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6-1"><span class="toc-text">创建应答文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%BA%94%E7%AD%94%E6%96%87%E4%BB%B6%E8%AE%BE%E7%BD%AE"><span class="toc-text">添加应答文件设置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0-OEM-%E4%BF%A1%E6%81%AF%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="toc-text">添加 OEM 信息（可选）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%86%E8%AE%BE%E5%A4%87%E8%AE%BE%E7%BD%AE%E4%B8%BA%E8%87%AA%E5%8A%A8%E5%90%AF%E5%8A%A8%E8%BF%9B%E5%85%A5%E5%AE%A1%E6%A0%B8%E6%A8%A1%E5%BC%8F"><span class="toc-text">将设备设置为自动启动进入审核模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E7%94%A8-S-%E6%A8%A1%E5%BC%8F"><span class="toc-text">启用 S 模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E5%88%B6%E9%80%A0%E6%A8%A1%E5%BC%8F"><span class="toc-text">启用制造模式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE-Windows-%E7%89%88%E6%9C%AC"><span class="toc-text">设置 Windows 版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%81%A2%E5%A4%8D%E4%BF%9D%E7%95%99-Windows-%E8%AE%BE%E7%BD%AE"><span class="toc-text">通过恢复保留 Windows 设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96-WinRE%EF%BC%88%E7%AC%AC-1-%E9%83%A8%E5%88%86%EF%BC%89"><span class="toc-text">优化 WinRE（第 1 部分）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD%E6%98%A0%E5%83%8F"><span class="toc-text">卸载映像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E6%98%A0%E5%83%8F%E9%83%A8%E7%BD%B2%E5%88%B0%E6%96%B0%E7%94%B5%E8%84%91"><span class="toc-text">将映像部署到新电脑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%BF%9B%E5%85%A5-WinPE"><span class="toc-text">启动进入 WinPE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC%E5%BA%94%E7%94%A8%E6%98%A0%E5%83%8F"><span class="toc-text">使用部署脚本应用映像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E8%81%94%E6%9C%BA%E8%87%AA%E5%AE%9A%E4%B9%89%EF%BC%88%E5%AE%A1%E6%A0%B8%E6%A8%A1%E5%BC%8F%EF%BC%89"><span class="toc-text">进行联机自定义（审核模式）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%AE%A1%E6%A0%B8%E6%A8%A1%E5%BC%8F%E4%B8%8B%E9%AA%8C%E8%AF%81%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-text">在审核模式下验证自定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E7%89%88%E6%9C%AC"><span class="toc-text">验证版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81-S-%E6%A8%A1%E5%BC%8F"><span class="toc-text">验证 S 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%92%8C-Store-%E5%95%86%E6%9C%BA"><span class="toc-text">应用和 Store 商机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E6%98%A0%E5%83%8F%E4%BB%A5%E5%AE%9E%E7%8E%B0%E4%B8%80%E9%94%AE%E9%87%8D%E7%BD%AE"><span class="toc-text">准备映像以实现一键重置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87-ScanState"><span class="toc-text">准备 ScanState</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-ScanState-%E8%BF%81%E7%A7%BB%E6%96%87%E4%BB%B6"><span class="toc-text">创建 ScanState 迁移文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ScanState-%E5%88%9B%E5%BB%BA%E6%81%A2%E5%A4%8D%E5%8C%85"><span class="toc-text">使用 ScanState 创建恢复包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%89%A9%E5%B1%95%E6%80%A7%E8%84%9A%E6%9C%AC%E4%BB%A5%E8%BF%98%E5%8E%9F%E5%85%B6%E4%BB%96%E8%AE%BE%E7%BD%AE"><span class="toc-text">创建扩展性脚本以还原其他设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%94%A8%E4%BA%8E%E8%BF%98%E5%8E%9F%E8%AE%BE%E7%BD%AE%E7%9A%84-unattend-xml-%E6%96%87%E4%BB%B6"><span class="toc-text">复制用于还原设置的 unattend.xml 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6-winre-wim-%E5%A4%87%E4%BB%BD"><span class="toc-text">复制 winre.wim 备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AF%86%E5%B0%81%E6%98%A0%E5%83%8F"><span class="toc-text">重新密封映像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4-S-%E6%A8%A1%E5%BC%8F-Windows-10-%E7%9A%84-manufacturing-%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%A1%B9"><span class="toc-text">删除 S 模式 Windows 10 的 manufacturing 注册表项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E7%A1%AE%E8%AE%A4%E5%B9%B6%E6%8D%95%E8%8E%B7%E6%98%A0%E5%83%8F"><span class="toc-text">最终确认并捕获映像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%96%91%E9%9A%BE%E8%A7%A3%E7%AD%94"><span class="toc-text">疑难解答</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BB%85%E9%99%90-CompactOS%EF%BC%89%E8%BD%AC%E6%8D%A2%E5%B7%B2%E5%AE%89%E8%A3%85%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A1%B9"><span class="toc-text">（仅限 CompactOS）转换已安装的自定义项</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E6%98%A0%E5%83%8F"><span class="toc-text">捕获映像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7-WIM"><span class="toc-text">捕获 WIM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7-FFU"><span class="toc-text">捕获 FFU</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%9C%80%E7%BB%88%E6%98%A0%E5%83%8F"><span class="toc-text">验证最终映像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E6%98%A0%E5%83%8F%E9%83%A8%E7%BD%B2%E5%88%B0%E5%8F%82%E8%80%83%E8%AE%BE%E5%A4%87"><span class="toc-text">将映像部署到参考设备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE"><span class="toc-text">验证配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%81%A2%E5%A4%8D"><span class="toc-text">验证恢复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%9C%80%E7%BB%88%E6%98%A0%E5%83%8F"><span class="toc-text">优化最终映像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E4%BA%A4%E4%BB%98"><span class="toc-text">最终交付</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%8F%E5%B0%91%E7%A3%81%E7%9B%98%E5%8D%A0%E7%94%A8%E9%87%8F"><span class="toc-text">减少磁盘占用量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%A9%E5%B0%8F%E5%92%8C%E5%85%B3%E9%97%AD-Hiberfile"><span class="toc-text">缩小和关闭 Hiberfile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86-Hiberfile-%E7%BC%A9%E5%B0%8F-30"><span class="toc-text">将 Hiberfile 缩小 30%</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%97%AD-Hiberfile"><span class="toc-text">关闭 Hiberfile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%8F%E8%BF%87%E4%BC%98%E5%8C%96%E7%9A%84%E7%A3%81%E7%9B%98%E5%8D%A0%E7%94%A8%E9%87%8F"><span class="toc-text">经过优化的磁盘占用量</span></a></li></ol></li></ol> -->
        <div class="toc"></div>
      </div>
    </div>
  </div>
</section>
<!-- 手机端目录按钮 -->
<div id="toc-mobile-btn">
  <i class="fas fa-list-ul" aria-hidden="true"></i>
</div>

      
  <section class="widget side_recent_post">
    
  <header>
    
      <a style="color: " href='/tags/'><i class="fas fa-book fa-fw" aria-hidden="true"></i><span class='name'>最新文章</span></a>
    
  </header>


    <div class='content'>
      
      <!-- hash算法 -->
      
      <div class="aside-list">
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2025/02/04/%E5%BE%AE%E8%BD%AFoffice/Office%E6%BF%80%E6%B4%BB%E5%90%8E%EF%BC%8C%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E4%B8%AD%E6%98%BE%E7%A4%BA%E8%B4%A6%E6%88%B7%E9%94%99%E8%AF%AF/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://picx.zhimg.com/80/v2-f3f11e8c9760e1bd9851eebc0852ae04_1440w.jpeg" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-f3f11e8c9760e1bd9851eebc0852ae04_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">02-04</span>
                
              </div>
              <a class="post-title" href="/2025/02/04/%E5%BE%AE%E8%BD%AFoffice/Office%E6%BF%80%E6%B4%BB%E5%90%8E%EF%BC%8C%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E4%B8%AD%E6%98%BE%E7%A4%BA%E8%B4%A6%E6%88%B7%E9%94%99%E8%AF%AF/">Office激活后，用户信息中显示账户错误</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/10/03/Dell%20G7%20%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB%E8%AE%BE%E5%A4%87%20-%20Goodix%20fingerprint%20%E5%A4%B1%E6%95%88%E5%AE%98%E6%96%B9%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%88%E5%9B%BE%E6%96%87%EF%BC%89/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://picx.zhimg.com/80/v2-60ff53bf4d8a843adf9f449761726048_1440w.jpeg" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-60ff53bf4d8a843adf9f449761726048_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">10-03</span>
                
              </div>
              <a class="post-title" href="/2024/10/03/Dell%20G7%20%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB%E8%AE%BE%E5%A4%87%20-%20Goodix%20fingerprint%20%E5%A4%B1%E6%95%88%E5%AE%98%E6%96%B9%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%88%E5%9B%BE%E6%96%87%EF%BC%89/">Dell G7 指纹识别设备-Goodix fingerprint 失效官方解决办法（图文）</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/10/03/CMGE%20V0-H%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://picx.zhimg.com/80/v2-2dd53578bed3716bc2dc7fd797218557_1440w.jpeg" class="lazyload placeholder" data-srcset="https://picx.zhimg.com/80/v2-2dd53578bed3716bc2dc7fd797218557_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">10-03</span>
                
              </div>
              <a class="post-title" href="/2024/10/03/CMGE%20V0-H%E5%AE%89%E8%A3%85%E8%AF%B4%E6%98%8E/">CMGE V0-H安装说明</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/10/03/win7%E5%AE%89%E8%A3%85edge%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%90%E7%A4%BA%E6%AD%A4%E7%89%88%E6%9C%AC%E7%9A%84%20Windows%20%E4%B8%8D%E5%86%8D%E6%94%AF%E6%8C%81%20Microsoft%20Edge/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pica.zhimg.com/80/v2-a6084cf7dfbac81b538315b6fa3cff09_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pica.zhimg.com/80/v2-a6084cf7dfbac81b538315b6fa3cff09_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">10-03</span>
                
              </div>
              <a class="post-title" href="/2024/10/03/win7%E5%AE%89%E8%A3%85edge%E6%B5%8F%E8%A7%88%E5%99%A8%E6%8F%90%E7%A4%BA%E6%AD%A4%E7%89%88%E6%9C%AC%E7%9A%84%20Windows%20%E4%B8%8D%E5%86%8D%E6%94%AF%E6%8C%81%20Microsoft%20Edge/">win7安装edge浏览器提示:此版本的 Windows 不再支持 Microsoft Edge</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/10/03/%E7%B3%BB%E7%BB%9F%E5%87%86%E5%A4%87%E5%B7%A5%E5%85%B7%20(Sysprep.exe)%20%E5%AE%9E%E7%8E%B0OOBE%E7%94%A8%E6%B3%95/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic1.zhimg.com/80/v2-1172c6f8a22b5e244e0fc3ac251b9ad1_1440w.jpeg" class="lazyload placeholder" data-srcset="https://pic1.zhimg.com/80/v2-1172c6f8a22b5e244e0fc3ac251b9ad1_1440w.jpeg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">10-03</span>
                
              </div>
              <a class="post-title" href="/2024/10/03/%E7%B3%BB%E7%BB%9F%E5%87%86%E5%A4%87%E5%B7%A5%E5%85%B7%20(Sysprep.exe)%20%E5%AE%9E%E7%8E%B0OOBE%E7%94%A8%E6%B3%95/">系统准备工具 (Sysprep.exe) 实现OOBE用法</a>
            </div>
          </div>
        
      </div>
    </div>
  </section>

    
  </div>
</aside>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '180000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || '';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'default',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- 页脚 -->
    
  
  
    <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = '' || 'rgba(66, 185, 133, 0.8)';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2025 <a href="/">南辞的家</a> <br> Powered by <a target="_blank" rel="noopener" href="https://space.bilibili.com/689915465">南辞</a> | <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/">Hexo</a> <br> Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a></p>

          </div>
        
      
        
          
            <!-- 不蒜子统计 -->
            <!-- 不蒜子统计 -->
<span id="busuanzi_container_site_pv">
      <i class="fas fa-eye" aria-hidden="true"></i>本站总访问量：<span id="busuanzi_value_site_pv"></span> 次
</span>
<span class="post-meta-divider">|</span>
<span id="busuanzi_container_site_uv" style='display:none'>
      <i class="fas fa-users" aria-hidden="true"></i>本站访客数：<span id="busuanzi_value_site_uv"></span> 人
</span>

          
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark">
  <div class="dark-content">
    <i class="fas fa-moon" aria-hidden="true"></i>
    <!-- <span>关灯</span> -->
  </div>
  
</div>

<script>
  $(function() {
    let isDark = JSON.parse(localStorage.getItem('dark'))  || JSON.parse('false');
    if (isDark) {
      $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
    }
    $('.dark').click(function() {
      if ($(document.body).is('.darkModel')) {
        $(document.body).removeClass('darkModel');
        localStorage.setItem('dark', false);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-moon" aria-hidden="true"></i>
          </div>
          `
        );
      } else {
        $(document.body).addClass('darkModel');
        localStorage.setItem('dark', true);
        $(".dark-content").replaceWith(
          `
          <div class='dark-content'>
            <i class="fas fa-lightbulb" aria-hidden="true"></i>
          </div>
          `
        );
      }
    })
  })
</script>
    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  font-size: 15px;
  color: #42b983;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="netease"
  type="playlist"
  id="6833016027"
  fixed='true'
  autoplay='false'
  theme='#42b983'
  loop='all'
  order='random'
  preload='auto'
  volume='2'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script src="https://unpkg.com/meting@2/dist/Meting.min.js"></script>
    

    <!-- 图片放大 -->
    
      <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- 背景彩带 -->
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<!-- <link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.css">

<script>
  var headerEl = 'h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -70,
    // headingsOffset: -($(window).height() * 0.4 - 45),
    headingsOffset: -($(window).height() * 0.4 - 70),
    // positionFixedSelector: '.toc-main',
    // positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    orderedList: true,
    collapseDepth: 20,
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 150) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('side_toc')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  /* .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  } */
</style>
 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 渲染远程json加载的图片标签(getPhotoOnline)里的内容 -->
<script>
  function loadPhotoOnlineJS() {
    if ($(".post-detail").find(".getJsonPhoto-api").length == 0) {
      return;
    } 
    loadScript('/js/getPhotoOnline/index.js');
  };
  $(function () {
    loadPhotoOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getPhotoJson == "undefined") {
      loadPhotoOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的talk标签(getTalkOnline)里的内容 -->
<script>
  function loadTalkOnlineJS() {
    if ($(".post-detail").find(".getJsonTalk-api").length == 0) {
      return;
    } 
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js'); // 瀑布流插件，https://raphamorim.io/waterfall.js/
    loadScript('/js/getTalkOnline/index.js');
  };
  $(function () {
    loadTalkOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getTalkJson == "undefined") {
      loadTalkOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的site-card标签(getSiteOnline)里的内容 -->
<script>
  function loadSiteOnlineJS() {
    if ($(".post-detail").find(".getJsonSite-api").length == 0) {
      return;
    } 
    loadScript('/js/getSiteOnline/index.js');
  };
  $(function () {
    loadSiteOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getSiteJson == "undefined") {
      loadSiteOnlineJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://unpkg.com/v-plugs-ayu/lib/ayu.css">
  <script src="https://unpkg.com/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = '复制';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://unpkg.com/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
    <script type="text/javascript">
  var utteranceCommon = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceCommon.Theme = 'github-dark';
    } else {
      utteranceCommon.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceCommon.Theme)
      utterances.setAttribute('repo', '')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceCommon.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
  


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

  
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 999; pointer-events: none;" ></canvas>
    <script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script src="/js/cursor/explosion.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


<!-- 轮播图标签 -->
<script>
  var bambooSwiperTag = {};
  function load_swiper() {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    loadCSS("https://unpkg.com/swiper@6/swiper-bundle.min.css")
    loadScript("https://unpkg.com/swiper@6/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    bambooSwiperTag.swiper = new Swiper('.post-swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      autoplay: true ? {
        delay: 3000,
        stopOnLastSlide: false,
        disableOnInteraction: false,
      } : false,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      on:{
        init: function(){
          swiperAnimateCache(this); //隐藏动画元素 
          swiperAnimate(this); //初始化完成开始动画
        }, 
        slideChangeTransitionEnd: function(){ 
          swiperAnimate(this); //每个slide切换结束时也运行当前slide动画
          //this.slides.eq(this.activeIndex).find('.ani').removeClass('ani'); 动画只展现一次，去除ani类名
        } 
      }
    });
  }

  document.addEventListener('pjax:complete', function () {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    if (typeof bambooSwiperTag.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>
    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <!-- 样式位于：source/css/_third-party/pjaxanimate.styl -->

<div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>